<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartPiXL // TRON</title>
<style>
/* ============================================================================
   TRON AESTHETIC — Glowing cyan on deep black, scan-line overlay, pulsing data
   ============================================================================ */
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Share+Tech+Mono&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #030810;
  --bg2: #060e1a;
  --panel: rgba(6, 20, 40, 0.85);
  --panel-border: rgba(0, 243, 255, 0.2);
  --panel-glow: rgba(0, 243, 255, 0.05);
  --cyan: #00f3ff;
  --cyan-dim: rgba(0, 243, 255, 0.5);
  --cyan-ghost: rgba(0, 243, 255, 0.08);
  --orange: #ff6a00;
  --orange-dim: rgba(255, 106, 0, 0.5);
  --red: #ff2d55;
  --red-dim: rgba(255, 45, 85, 0.5);
  --green: #00ff88;
  --green-dim: rgba(0, 255, 136, 0.5);
  --yellow: #ffe14d;
  --text: #c0e8ff;
  --text-dim: rgba(140, 180, 210, 0.6);
  --mono: 'Share Tech Mono', 'Consolas', monospace;
  --display: 'Orbitron', sans-serif;
}

html { font-size: 14px; }

body {
  font-family: var(--mono);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}

/* Scan-line overlay */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 2px,
    rgba(0, 243, 255, 0.015) 2px,
    rgba(0, 243, 255, 0.015) 4px
  );
  pointer-events: none;
  z-index: 9999;
}

/* Grid background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    linear-gradient(rgba(0,243,255,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,243,255,0.03) 1px, transparent 1px);
  background-size: 60px 60px;
  pointer-events: none;
  z-index: 0;
}

/* ─── LAYOUT ─── */
.dashboard {
  position: relative;
  z-index: 1;
  max-width: 1800px;
  margin: 0 auto;
  padding: 16px 24px;
}

/* ─── HEADER ─── */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0 20px;
  border-bottom: 1px solid var(--panel-border);
  margin-bottom: 24px;
}

.header-left { display: flex; align-items: center; gap: 16px; }

.logo {
  font-family: var(--display);
  font-size: 1.6rem;
  font-weight: 900;
  letter-spacing: 6px;
  text-transform: uppercase;
  color: var(--cyan);
  text-shadow: 0 0 20px var(--cyan-dim), 0 0 60px rgba(0,243,255,0.2);
}

.logo-sub {
  font-family: var(--mono);
  font-size: 0.7rem;
  color: var(--text-dim);
  letter-spacing: 3px;
  text-transform: uppercase;
}

.status-beacon {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.75rem;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.beacon-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 8px var(--green), 0 0 20px var(--green-dim);
  animation: pulse 2s ease-in-out infinite;
}

.beacon-dot.warn { background: var(--yellow); box-shadow: 0 0 8px var(--yellow), 0 0 20px rgba(255,225,77,0.3); }
.beacon-dot.danger { background: var(--red); box-shadow: 0 0 8px var(--red), 0 0 20px var(--red-dim); }

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.8); }
}

.header-right {
  display: flex;
  align-items: center;
  gap: 20px;
  font-size: 0.75rem;
  color: var(--text-dim);
}

.refresh-timer {
  font-family: var(--mono);
  color: var(--cyan-dim);
}

/* ─── HERO METRICS ─── */
.hero-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.hero-card {
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 4px;
  padding: 16px 20px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.3s, box-shadow 0.3s;
}

.hero-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--cyan), transparent);
  opacity: 0.6;
}

.hero-card:hover {
  border-color: var(--cyan-dim);
  box-shadow: 0 0 30px var(--panel-glow), inset 0 0 30px var(--panel-glow);
}

.hero-label {
  font-family: var(--display);
  font-size: 0.6rem;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-bottom: 8px;
}

.hero-value {
  font-family: var(--display);
  font-size: 2rem;
  font-weight: 700;
  color: var(--cyan);
  text-shadow: 0 0 20px var(--cyan-dim);
  line-height: 1;
}

.hero-value.warn { color: var(--yellow); text-shadow: 0 0 20px rgba(255,225,77,0.3); }
.hero-value.danger { color: var(--red); text-shadow: 0 0 20px var(--red-dim); }
.hero-value.good { color: var(--green); text-shadow: 0 0 20px var(--green-dim); }

.hero-sub {
  font-size: 0.7rem;
  color: var(--text-dim);
  margin-top: 6px;
}

/* ─── PANELS ─── */
.panel-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
  margin-bottom: 24px;
}

.panel-grid.triple {
  grid-template-columns: 1fr 1fr 1fr;
}

.panel-grid.half {
  grid-template-columns: 1fr 1fr;
}

.panel {
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 4px;
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.panel::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--cyan-dim), transparent);
}

.panel-title {
  font-family: var(--display);
  font-size: 0.7rem;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--cyan);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.panel-title::before {
  content: '//';
  color: var(--text-dim);
}

/* ─── HOURLY CHART ─── */
.chart-container {
  height: 200px;
  display: flex;
  align-items: flex-end;
  gap: 2px;
  padding-top: 10px;
}

.chart-bar-group {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  min-width: 0;
}

.chart-bar {
  width: 100%;
  min-height: 1px;
  border-radius: 1px 1px 0 0;
  transition: height 0.6s ease;
  position: relative;
}

.chart-bar.human {
  background: linear-gradient(to top, rgba(0,243,255,0.3), rgba(0,243,255,0.7));
  box-shadow: 0 0 6px rgba(0,243,255,0.3);
}

.chart-bar.bot {
  background: linear-gradient(to top, rgba(255,45,85,0.3), rgba(255,45,85,0.7));
  box-shadow: 0 0 6px rgba(255,45,85,0.3);
}

.chart-label {
  font-size: 0.55rem;
  color: var(--text-dim);
  writing-mode: vertical-rl;
  transform: rotate(180deg);
  max-height: 50px;
  overflow: hidden;
}

/* ─── RISK GAUGE ─── */
.risk-list { display: flex; flex-direction: column; gap: 12px; }

.risk-row {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 4px;
  border: 1px solid transparent;
  transition: all 0.2s;
}

.risk-row:hover {
  border-color: var(--panel-border);
  background: var(--cyan-ghost);
}

.risk-indicator {
  width: 6px;
  height: 32px;
  border-radius: 3px;
  flex-shrink: 0;
}

.risk-indicator.high { background: var(--red); box-shadow: 0 0 8px var(--red-dim); }
.risk-indicator.medium { background: var(--orange); box-shadow: 0 0 8px var(--orange-dim); }
.risk-indicator.low { background: var(--yellow); box-shadow: 0 0 6px rgba(255,225,77,0.3); }
.risk-indicator.ok { background: var(--green); box-shadow: 0 0 6px var(--green-dim); }

.risk-info { flex: 1; }
.risk-label { font-size: 0.75rem; letter-spacing: 1px; }
.risk-count {
  font-family: var(--display);
  font-size: 1.3rem;
  font-weight: 700;
}

.risk-meta { font-size: 0.65rem; color: var(--text-dim); }

/* ─── LIVE FEED TABLE ─── */
.feed-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.75rem;
}

.feed-table th {
  font-family: var(--display);
  font-size: 0.6rem;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--cyan-dim);
  text-align: left;
  padding: 8px 10px;
  border-bottom: 1px solid var(--panel-border);
}

.feed-table td {
  padding: 6px 10px;
  border-bottom: 1px solid rgba(0,243,255,0.05);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 180px;
}

.feed-table tr {
  transition: background 0.2s;
}

.feed-table tr:hover {
  background: var(--cyan-ghost);
}

.feed-table tr.new-row {
  animation: rowFlash 1.5s ease-out;
}

@keyframes rowFlash {
  0% { background: rgba(0,243,255,0.15); }
  100% { background: transparent; }
}

/* ─── THREAT BADGE ─── */
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 2px;
  font-family: var(--display);
  font-size: 0.6rem;
  font-weight: 700;
  letter-spacing: 1px;
}

.badge.high { background: rgba(255,45,85,0.2); color: var(--red); border: 1px solid rgba(255,45,85,0.3); }
.badge.med { background: rgba(255,106,0,0.2); color: var(--orange); border: 1px solid rgba(255,106,0,0.3); }
.badge.low { background: rgba(255,225,77,0.15); color: var(--yellow); border: 1px solid rgba(255,225,77,0.2); }
.badge.ok { background: rgba(0,255,136,0.1); color: var(--green); border: 1px solid rgba(0,255,136,0.2); }

/* ─── SIGNAL BARS ─── */
.signal-list { display: flex; flex-direction: column; gap: 8px; }

.signal-row {
  display: flex;
  align-items: center;
  gap: 10px;
}

.signal-name {
  width: 180px;
  flex-shrink: 0;
  font-size: 0.7rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.signal-bar-track {
  flex: 1;
  height: 14px;
  background: rgba(0,243,255,0.05);
  border-radius: 2px;
  overflow: hidden;
  position: relative;
}

.signal-bar-fill {
  height: 100%;
  border-radius: 2px;
  background: linear-gradient(90deg, var(--cyan-dim), var(--cyan));
  box-shadow: 0 0 10px var(--cyan-dim);
  transition: width 0.8s ease;
  position: relative;
}

.signal-bar-fill::after {
  content: '';
  position: absolute;
  right: 0; top: 0; bottom: 0;
  width: 2px;
  background: var(--cyan);
  box-shadow: 0 0 6px var(--cyan);
}

.signal-count {
  width: 50px;
  text-align: right;
  font-size: 0.7rem;
  color: var(--cyan);
}

/* ─── EVASION GRID ─── */
.evasion-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

.evasion-card {
  text-align: center;
  padding: 12px;
  background: rgba(0,243,255,0.03);
  border: 1px solid rgba(0,243,255,0.08);
  border-radius: 4px;
}

.evasion-val {
  font-family: var(--display);
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--cyan);
}

.evasion-val.alert { color: var(--red); text-shadow: 0 0 10px var(--red-dim); }

.evasion-lbl {
  font-size: 0.6rem;
  color: var(--text-dim);
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-top: 4px;
}

/* ─── BEHAVIOR COMPARISON ─── */
.behavior-compare {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.behavior-col { text-align: center; }
.behavior-col-title {
  font-family: var(--display);
  font-size: 0.65rem;
  letter-spacing: 3px;
  text-transform: uppercase;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--panel-border);
}

.behavior-col-title.human { color: var(--cyan); }
.behavior-col-title.bot { color: var(--red); }

.behavior-stat {
  display: flex;
  justify-content: space-between;
  padding: 4px 8px;
  font-size: 0.7rem;
}

.behavior-stat .val { font-weight: bold; }

/* ─── FINGERPRINT CLUSTERS ─── */
.fp-cluster-list { display: flex; flex-direction: column; gap: 6px; }

.fp-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 3px;
  border: 1px solid transparent;
  transition: all 0.2s;
  font-size: 0.7rem;
}

.fp-row:hover {
  border-color: var(--panel-border);
  background: var(--cyan-ghost);
}

.fp-hash {
  font-family: var(--mono);
  color: var(--cyan);
  width: 100px;
  flex-shrink: 0;
}

.fp-meta { flex: 1; color: var(--text-dim); }
.fp-hits {
  font-family: var(--display);
  font-weight: 700;
  color: var(--text);
}

/* ─── PIPELINE ANIMATION ─── */
.pipeline {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  margin: 12px 0;
  padding: 16px 0;
}

.pipe-node {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  padding: 12px 20px;
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 4px;
  min-width: 120px;
}

.pipe-node-label {
  font-family: var(--display);
  font-size: 0.55rem;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--cyan);
}

.pipe-node-value {
  font-family: var(--display);
  font-size: 1rem;
  font-weight: 700;
}

.pipe-arrow {
  width: 40px;
  height: 2px;
  background: linear-gradient(90deg, var(--cyan-dim), var(--cyan));
  position: relative;
  animation: dataFlow 2s linear infinite;
}

.pipe-arrow::after {
  content: '';
  position: absolute;
  right: -6px;
  top: -4px;
  width: 0; height: 0;
  border-left: 8px solid var(--cyan);
  border-top: 5px solid transparent;
  border-bottom: 5px solid transparent;
}

@keyframes dataFlow {
  0% { opacity: 0.3; }
  50% { opacity: 1; }
  100% { opacity: 0.3; }
}

/* ─── LOADING ─── */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
  color: var(--text-dim);
  font-size: 0.75rem;
  letter-spacing: 3px;
}

.loading::after {
  content: '';
  width: 16px;
  height: 16px;
  border: 2px solid var(--panel-border);
  border-top-color: var(--cyan);
  border-radius: 50%;
  margin-left: 12px;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ─── RESPONSIVE ─── */
@media (max-width: 1400px) {
  .hero-grid { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 900px) {
  .hero-grid { grid-template-columns: repeat(2, 1fr); }
  .panel-grid, .panel-grid.triple, .panel-grid.half { grid-template-columns: 1fr; }
  .evasion-grid { grid-template-columns: repeat(2, 1fr); }
}

/* ─── SCROLLBAR ─── */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--panel-border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--cyan-dim); }

/* ─── INFRASTRUCTURE HEALTH ─── */
.infra-section {
  margin-bottom: 24px;
}

.infra-status-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  border-radius: 4px;
  margin-bottom: 16px;
  border: 1px solid var(--panel-border);
}

.infra-status-bar.healthy {
  background: rgba(0,255,136,0.06);
  border-color: rgba(0,255,136,0.3);
}

.infra-status-bar.degraded {
  background: rgba(255,225,77,0.06);
  border-color: rgba(255,225,77,0.3);
}

.infra-status-bar.critical {
  background: rgba(255,45,85,0.06);
  border-color: rgba(255,45,85,0.3);
}

.infra-status-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  flex-shrink: 0;
  animation: pulse 2s ease-in-out infinite;
}

.infra-status-dot.healthy { background: var(--green); box-shadow: 0 0 10px var(--green-dim); }
.infra-status-dot.degraded { background: var(--yellow); box-shadow: 0 0 10px rgba(255,225,77,0.4); }
.infra-status-dot.critical { background: var(--red); box-shadow: 0 0 10px var(--red-dim); animation: pulse 0.8s ease-in-out infinite; }

.infra-status-text {
  font-family: var(--display);
  font-size: 0.75rem;
  letter-spacing: 3px;
  text-transform: uppercase;
}

.infra-status-bar.healthy .infra-status-text { color: var(--green); }
.infra-status-bar.degraded .infra-status-text { color: var(--yellow); }
.infra-status-bar.critical .infra-status-text { color: var(--red); }

.infra-probe-time {
  margin-left: auto;
  font-size: 0.65rem;
  color: var(--text-dim);
}

.infra-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

.infra-group-title {
  font-family: var(--display);
  font-size: 0.6rem;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--cyan-dim);
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--panel-border);
}

.infra-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 0;
  font-size: 0.75rem;
}

.infra-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.infra-dot.up { background: var(--green); box-shadow: 0 0 6px var(--green-dim); }
.infra-dot.down { background: var(--red); box-shadow: 0 0 6px var(--red-dim); }
.infra-dot.warn { background: var(--yellow); box-shadow: 0 0 6px rgba(255,225,77,0.3); }

.infra-item-name { flex: 1; }
.infra-item-detail {
  font-size: 0.65rem;
  color: var(--text-dim);
  text-align: right;
}

.infra-item-ms {
  font-family: var(--display);
  font-size: 0.65rem;
  color: var(--cyan-dim);
  width: 50px;
  text-align: right;
}

.infra-app-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 8px;
}

.infra-app-stat {
  text-align: center;
  padding: 8px 4px;
  background: rgba(0,243,255,0.03);
  border: 1px solid rgba(0,243,255,0.06);
  border-radius: 3px;
}

.infra-app-val {
  font-family: var(--display);
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--cyan);
}

.infra-app-lbl {
  font-size: 0.55rem;
  color: var(--text-dim);
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-top: 2px;
}

@media (max-width: 900px) {
  .infra-grid { grid-template-columns: 1fr; }
  .infra-app-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<div class="dashboard">
  <!-- ═══════════════════ HEADER ═══════════════════ -->
  <div class="header">
    <div class="header-left">
      <div>
        <div class="logo">SMARTPIXL</div>
        <div class="logo-sub">Threat Intelligence Grid</div>
      </div>
      <div class="status-beacon">
        <div class="beacon-dot" id="beacon"></div>
        <span id="system-status">CONNECTING...</span>
      </div>
    </div>
    <div class="header-right">
      <div>UTC <span id="utc-clock">--:--:--</span></div>
      <div>REFRESH <span class="refresh-timer" id="countdown">10</span>s</div>
      <div>ETL <span id="etl-status">--</span></div>
    </div>
  </div>

  <!-- ═══════════════════ HERO CARDS ═══════════════════ -->
  <div class="hero-grid" id="hero-grid">
    <div class="hero-card"><div class="hero-label">TOTAL HITS</div><div class="hero-value" id="h-total">--</div><div class="hero-sub" id="h-total-sub"></div></div>
    <div class="hero-card"><div class="hero-label">LAST 24H</div><div class="hero-value" id="h-24h">--</div><div class="hero-sub" id="h-24h-sub"></div></div>
    <div class="hero-card"><div class="hero-label">BOTS DETECTED</div><div class="hero-value" id="h-bots">--</div><div class="hero-sub" id="h-bots-sub"></div></div>
    <div class="hero-card"><div class="hero-label">BOT RATE</div><div class="hero-value" id="h-botpct">--</div><div class="hero-sub" id="h-botpct-sub"></div></div>
    <div class="hero-card"><div class="hero-label">UNIQUE FP</div><div class="hero-value" id="h-fp">--</div><div class="hero-sub" id="h-fp-sub"></div></div>
    <div class="hero-card"><div class="hero-label">EVASION</div><div class="hero-value" id="h-evasion">--</div><div class="hero-sub" id="h-evasion-sub"></div></div>
  </div>

  <!-- ═══════════════════ PIPELINE ═══════════════════ -->
  <div class="pipeline" id="pipeline">
    <div class="pipe-node">
      <div class="pipe-node-label">RAW HITS</div>
      <div class="pipe-node-value" id="pipe-raw">--</div>
    </div>
    <div class="pipe-arrow"></div>
    <div class="pipe-node">
      <div class="pipe-node-label">ETL PARSE</div>
      <div class="pipe-node-value" id="pipe-parsed">--</div>
    </div>
    <div class="pipe-arrow"></div>
    <div class="pipe-node">
      <div class="pipe-node-label">167 SIGNALS</div>
      <div class="pipe-node-value" style="color:var(--cyan); font-size:0.7rem;">PER HIT</div>
    </div>
    <div class="pipe-arrow"></div>
    <div class="pipe-node">
      <div class="pipe-node-label">DASHBOARD</div>
      <div class="pipe-node-value" style="color:var(--green);">LIVE</div>
    </div>
  </div>

  <!-- ═══════════════════ HOURLY + RISK ═══════════════════ -->
  <div class="panel-grid">
    <div class="panel">
      <div class="panel-title">HOURLY TRAFFIC</div>
      <div class="chart-container" id="hourly-chart"><div class="loading">LOADING</div></div>
    </div>
    <div class="panel">
      <div class="panel-title">RISK BREAKDOWN</div>
      <div class="risk-list" id="risk-list"><div class="loading">LOADING</div></div>
    </div>
  </div>

  <!-- ═══════════════════ LIVE FEED + SIGNALS ═══════════════════ -->
  <div class="panel-grid">
    <div class="panel">
      <div class="panel-title">LIVE FEED</div>
      <div style="overflow-x:auto;">
        <table class="feed-table">
          <thead>
            <tr>
              <th>TIME</th>
              <th>IP</th>
              <th>THREAT</th>
              <th>SCORE</th>
              <th>PLATFORM</th>
              <th>BROWSER</th>
              <th>RESOLUTION</th>
              <th>FINGERPRINT</th>
              <th>SIGNALS</th>
            </tr>
          </thead>
          <tbody id="feed-body"><tr><td colspan="9" class="loading">LOADING</td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="panel">
      <div class="panel-title">TOP BOT SIGNALS</div>
      <div class="signal-list" id="signal-list"><div class="loading">LOADING</div></div>
    </div>
  </div>

  <!-- ═══════════════════ EVASION + BEHAVIOR + FINGERPRINTS ═══════════════════ -->
  <div class="panel-grid triple">
    <div class="panel">
      <div class="panel-title">EVASION COUNTERMEASURES</div>
      <div class="evasion-grid" id="evasion-grid"><div class="loading">LOADING</div></div>
    </div>
    <div class="panel">
      <div class="panel-title">BEHAVIORAL ANALYSIS</div>
      <div class="behavior-compare" id="behavior-compare"><div class="loading">LOADING</div></div>
    </div>
    <div class="panel">
      <div class="panel-title">FINGERPRINT CLUSTERS</div>
      <div class="fp-cluster-list" id="fp-clusters"><div class="loading">LOADING</div></div>
    </div>
  </div>

  <!-- ═══════════════════ DEVICES ═══════════════════ -->
  <div class="panel-grid half">
    <div class="panel">
      <div class="panel-title">DEVICE BREAKDOWN</div>
      <div id="device-breakdown"><div class="loading">LOADING</div></div>
    </div>
    <div class="panel">
      <div class="panel-title">ETL HEALTH</div>
      <div id="etl-details" style="font-size:0.75rem;"><div class="loading">LOADING</div></div>
    </div>
  </div>

  <!-- ═══════════════════ INFRASTRUCTURE HEALTH ═══════════════════ -->
  <div class="infra-section">
    <div class="panel">
      <div class="panel-title">INFRASTRUCTURE HEALTH</div>
      <div id="infra-panel"><div class="loading">LOADING</div></div>
    </div>
  </div>
</div>

<script>
// ============================================================================
// DATA LAYER
// ============================================================================
const API = {
  health:       () => fetchJson('/api/dash/health'),
  hourly:       (h=48) => fetchJson(`/api/dash/hourly?hours=${h}`),
  bots:         () => fetchJson('/api/dash/bots'),
  signals:      () => fetchJson('/api/dash/bot-signals'),
  devices:      () => fetchJson('/api/dash/devices'),
  evasion:      () => fetchJson('/api/dash/evasion'),
  behavior:     () => fetchJson('/api/dash/behavior'),
  recent:       () => fetchJson('/api/dash/recent'),
  fingerprints: () => fetchJson('/api/dash/fingerprints?limit=12'),
  infra:        () => fetchJson('/api/dash/infra'),
};

async function fetchJson(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`${res.status}`);
    return await res.json();
  } catch (e) {
    console.warn('Fetch failed:', url, e);
    return null;
  }
}

// ============================================================================
// RENDERERS
// ============================================================================

function renderHero(h) {
  if (!h) return;
  const set = (id, val, sub) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
    const subEl = document.getElementById(id + '-sub');
    if (subEl && sub) subEl.textContent = sub;
  };

  set('h-total', num(h.totalHits), `${num(h.hits_7d)} last 7d`);
  set('h-24h', num(h.hits_24h), `${num(h.hits_1h)} last hour`);
  set('h-bots', num(h.bots_24h), `${num(h.highRiskBots_24h)} high risk`);

  const pct = h.botPct_24h || 0;
  const pctEl = document.getElementById('h-botpct');
  pctEl.textContent = pct.toFixed(1) + '%';
  pctEl.className = 'hero-value' + (pct > 30 ? ' danger' : pct > 10 ? ' warn' : ' good');
  document.getElementById('h-botpct-sub').textContent = `avg score ${(h.avgBotScore_24h||0).toFixed(1)}`;

  set('h-fp', num(h.uniqueFP_24h), `${num(h.uniqueFP_AllTime)} all time`);
  
  const evEl = document.getElementById('h-evasion');
  evEl.textContent = num(h.evasionDetected_AllTime);
  evEl.className = 'hero-value' + (h.evasionDetected_AllTime > 0 ? ' warn' : ' good');
  document.getElementById('h-evasion-sub').textContent = `${num(h.webDriverHits)} webdriver`;

  // Pipeline
  document.getElementById('pipe-raw').textContent = num(h.etL_TotalProcessed || h.totalHits);
  document.getElementById('pipe-parsed').textContent = num(h.totalHits);

  // Status beacon
  const beacon = document.getElementById('beacon');
  const statusEl = document.getElementById('system-status');
  const secSince = h.secondsSinceLastHit || 9999;
  if (secSince < 300) {
    beacon.className = 'beacon-dot';
    statusEl.textContent = 'SYSTEM ONLINE';
  } else if (secSince < 3600) {
    beacon.className = 'beacon-dot warn';
    statusEl.textContent = 'IDLE — ' + formatDuration(secSince);
  } else {
    beacon.className = 'beacon-dot danger';
    statusEl.textContent = 'STALE — ' + formatDuration(secSince);
  }

  // ETL health
  document.getElementById('etl-status').textContent = 
    h.etL_Watermark ? `#${num(h.etL_Watermark)}` : '--';

  renderETLDetails(h);
}

function renderETLDetails(h) {
  const el = document.getElementById('etl-details');
  if (!h) return;
  el.innerHTML = `
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
      <div class="evasion-card">
        <div class="evasion-val">${num(h.etL_TotalProcessed||0)}</div>
        <div class="evasion-lbl">ROWS PROCESSED</div>
      </div>
      <div class="evasion-card">
        <div class="evasion-val">${num(h.etL_Watermark||0)}</div>
        <div class="evasion-lbl">WATERMARK ID</div>
      </div>
      <div class="evasion-card">
        <div class="evasion-val">${num(h.totalHits)}</div>
        <div class="evasion-lbl">PARSED ROWS</div>
      </div>
      <div class="evasion-card">
        <div class="evasion-val">${num(h.syntheticHits||0)}</div>
        <div class="evasion-lbl">SYNTHETIC</div>
      </div>
      <div class="evasion-card" style="grid-column:span 2;">
        <div class="evasion-val" style="font-size:0.9rem;">${h.etL_LastRunAt ? timeAgo(h.etL_LastRunAt) : '--'}</div>
        <div class="evasion-lbl">LAST ETL RUN</div>
      </div>
    </div>
  `;
}

function renderHourlyChart(data) {
  const container = document.getElementById('hourly-chart');
  if (!data || !data.length) { container.innerHTML = '<div class="loading">NO DATA</div>'; return; }

  // Reverse so oldest is left
  const rows = [...data].reverse().slice(-48);
  const maxHits = Math.max(...rows.map(r => r.totalHits || 1));

  container.innerHTML = rows.map(r => {
    const total = r.totalHits || 0;
    const bots = r.botHits || 0;
    const humans = total - bots;
    const humanH = Math.max(1, (humans / maxHits) * 180);
    const botH = Math.max(0, (bots / maxHits) * 180);
    const hour = new Date(r.hourBucket).getUTCHours();
    const label = hour === 0 ? new Date(r.hourBucket).toLocaleDateString('en',{month:'short',day:'numeric',timeZone:'UTC'}) : `${hour}h`;
    return `<div class="chart-bar-group" title="${total} hits (${bots} bots) at ${r.hourBucket}">
      <div class="chart-bar bot" style="height:${botH}px"></div>
      <div class="chart-bar human" style="height:${humanH}px"></div>
      ${hour % 6 === 0 ? `<div class="chart-label">${label}</div>` : ''}
    </div>`;
  }).join('');
}

function renderRiskList(data) {
  const el = document.getElementById('risk-list');
  if (!data || !data.length) { el.innerHTML = '<div style="color:var(--text-dim);font-size:0.75rem;">No data</div>'; return; }

  const indicatorClass = b => {
    if (b.riskBucket === 'High Risk') return 'high';
    if (b.riskBucket === 'Medium Risk') return 'medium';
    if (b.riskBucket === 'Low Risk') return 'low';
    return 'ok';
  };

  el.innerHTML = data.map(b => `
    <div class="risk-row">
      <div class="risk-indicator ${indicatorClass(b)}"></div>
      <div class="risk-info">
        <div class="risk-label">${b.riskBucket}</div>
        <div class="risk-meta">${num(b.uniqueDevices)} devices · ${num(b.uniqueIPs)} IPs</div>
      </div>
      <div class="risk-count">${num(b.hitCount)}</div>
    </div>
  `).join('');
}

function renderLiveFeed(data) {
  const tbody = document.getElementById('feed-body');
  if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="9" style="color:var(--text-dim)">No recent hits</td></tr>'; return; }

  tbody.innerHTML = data.slice(0, 30).map(r => {
    const t = r.threatLevel || 'OK';
    const badgeClass = t === 'HIGH' ? 'high' : t === 'MED' ? 'med' : t === 'LOW' ? 'low' : 'ok';
    const time = r.receivedAt ? new Date(r.receivedAt).toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}) : '--';
    return `<tr>
      <td>${time}</td>
      <td>${r.ipAddress || '--'}</td>
      <td><span class="badge ${badgeClass}">${t}</span></td>
      <td>${r.botScore ?? '--'}</td>
      <td>${r.platform || '--'}</td>
      <td>${r.browser || '--'}</td>
      <td>${r.resolution || '--'}</td>
      <td style="color:var(--cyan)">${r.fP_Short || '--'}</td>
      <td style="max-width:200px;color:var(--text-dim)">${r.botSignalsList || ''}</td>
    </tr>`;
  }).join('');
}

function renderSignals(data) {
  const el = document.getElementById('signal-list');
  if (!data || !data.length) { el.innerHTML = '<div style="color:var(--text-dim)">No signals</div>'; return; }

  const maxCount = Math.max(...data.map(s => s.timesTriggered || 1));

  el.innerHTML = data.slice(0, 12).map(s => {
    const pct = ((s.timesTriggered || 0) / maxCount * 100).toFixed(0);
    return `<div class="signal-row">
      <div class="signal-name" title="${s.signal}">${s.signal}</div>
      <div class="signal-bar-track"><div class="signal-bar-fill" style="width:${pct}%"></div></div>
      <div class="signal-count">${num(s.timesTriggered)}</div>
    </div>`;
  }).join('');
}

function renderEvasion(data) {
  const el = document.getElementById('evasion-grid');
  if (!data) { el.innerHTML = '<div>No data</div>'; return; }

  const items = [
    ['CANVAS', data.canvasEvasion, data.totalHits],
    ['WEBGL', data.webGLEvasion, data.totalHits],
    ['AUDIO NOISE', data.audioNoise, data.totalHits],
    ['FONT SPOOF', data.fontSpoof, data.totalHits],
    ['STEALTH', data.stealthDetected, data.totalHits],
    ['EVASION TOOLS', data.evasionToolsFound, data.totalHits],
    ['PROXY BLOCK', data.proxyBlocked, data.totalHits],
    ['EVASION V2', data.evasionV2Signals, data.totalHits],
    ['DNT ENABLED', data.dnT_Enabled, data.totalHits],
  ];

  el.innerHTML = items.map(([label, val, total]) => {
    const v = val || 0;
    const cls = v > 0 ? 'alert' : '';
    return `<div class="evasion-card">
      <div class="evasion-val ${cls}">${num(v)}</div>
      <div class="evasion-lbl">${label}</div>
    </div>`;
  }).join('');
}

function renderBehavior(data) {
  const el = document.getElementById('behavior-compare');
  if (!data || !data.length) { el.innerHTML = '<div>No data</div>'; return; }

  const human = data.find(d => d.classification && d.classification.includes('<50'));
  const bot = data.find(d => d.classification && d.classification.includes('50'));

  const stat = (label, hv, bv) => `
    <div class="behavior-stat"><span>${label}</span><span class="val">${hv??'--'}</span></div>
  `;

  const col = (title, cls, d) => `
    <div class="behavior-col">
      <div class="behavior-col-title ${cls}">${title}</div>
      ${stat('Hits', num(d?.hitCount))}
      ${stat('Avg Mouse Moves', (d?.avgMouseMoves||0).toFixed(0))}
      ${stat('Avg Entropy', (d?.avgMouseEntropy||0).toFixed(0))}
      ${stat('No Mouse', num(d?.noMouseHits))}
      ${stat('Zero Entropy', num(d?.zeroEntropyHits))}
      ${stat('Scrolled', num(d?.scrolledHits))}
      ${stat('Contradictions', num(d?.scrollContradictions))}
      ${stat('Flagged', num(d?.flaggedHits))}
    </div>
  `;

  el.innerHTML = col('HUMAN', 'human', human) + col('BOT', 'bot', bot);
}

function renderFingerprints(data) {
  const el = document.getElementById('fp-clusters');
  if (!data || !data.length) { el.innerHTML = '<div style="color:var(--text-dim)">No clusters</div>'; return; }

  el.innerHTML = data.slice(0, 10).map(fp => {
    const hash = (fp.canvasFingerprint || '--').substring(0, 12);
    const score = fp.avgBotScore != null ? fp.avgBotScore.toFixed(0) : '--';
    const scoreColor = score >= 50 ? 'var(--red)' : score >= 20 ? 'var(--yellow)' : 'var(--green)';
    return `<div class="fp-row">
      <div class="fp-hash">${hash}</div>
      <div class="fp-meta">${num(fp.uniqueIPs)} IPs · ${fp.primaryPlatform||'?'} · <span style="color:${scoreColor}">score ${score}</span></div>
      <div class="fp-hits">${num(fp.hitCount)}</div>
    </div>`;
  }).join('');
}

function renderDevices(data) {
  const el = document.getElementById('device-breakdown');
  if (!data || !data.length) { el.innerHTML = '<div style="color:var(--text-dim)">No data</div>'; return; }

  // Aggregate by platform
  const byPlatform = {};
  data.forEach(d => {
    const p = d.platform || 'Unknown';
    if (!byPlatform[p]) byPlatform[p] = { hits: 0, devices: 0, browsers: new Set() };
    byPlatform[p].hits += d.hitCount || 0;
    byPlatform[p].devices += d.uniqueDevices || 0;
    if (d.browser) byPlatform[p].browsers.add(d.browser);
  });

  const maxHits = Math.max(...Object.values(byPlatform).map(v => v.hits || 1));

  el.innerHTML = '<div class="signal-list">' + Object.entries(byPlatform)
    .sort((a, b) => b[1].hits - a[1].hits)
    .slice(0, 10)
    .map(([platform, info]) => {
      const pct = (info.hits / maxHits * 100).toFixed(0);
      return `<div class="signal-row">
        <div class="signal-name">${platform}</div>
        <div class="signal-bar-track"><div class="signal-bar-fill" style="width:${pct}%"></div></div>
        <div class="signal-count">${num(info.hits)}</div>
      </div>`;
    }).join('') + '</div>';
}

function renderInfra(data) {
  const el = document.getElementById('infra-panel');
  if (!data) { el.innerHTML = '<div style="color:var(--text-dim)">Infrastructure probe unavailable</div>'; return; }

  const status = data.overallStatus || 'unknown';
  const statusLabel = status === 'healthy' ? 'ALL SYSTEMS OPERATIONAL' :
                      status === 'degraded' ? 'DEGRADED — SOME ISSUES DETECTED' :
                      status === 'critical' ? 'CRITICAL — IMMEDIATE ATTENTION REQUIRED' : 'UNKNOWN';
  const checkedAt = data.checkedAt ? new Date(data.checkedAt).toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}) + ' UTC' : '--';

  // ── Status bar
  let html = `<div class="infra-status-bar ${status}">
    <div class="infra-status-dot ${status}"></div>
    <div class="infra-status-text">${statusLabel}</div>
    <div class="infra-probe-time">Probed in ${data.probeTimeMs || 0}ms · ${checkedAt}</div>
  </div>`;

  // ── Error banner (most important — shows at top if there are errors)
  if (data.recentErrors && data.recentErrors.hasErrors) {
    const re = data.recentErrors;
    const errAge = re.lastErrorUtc ? timeAgo(re.lastErrorUtc) : 'unknown';
    html += `<div style="background:rgba(255,45,85,0.1);border:1px solid rgba(255,45,85,0.4);border-radius:4px;padding:12px 16px;margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <div class="infra-dot down"></div>
        <span style="font-family:var(--display);font-size:0.7rem;letter-spacing:2px;color:var(--red);">
          ${re.totalErrorsToday} ERROR${re.totalErrorsToday > 1 ? 'S' : ''} TODAY · Last: ${errAge}
        </span>
      </div>`;
    re.errors.forEach(e => {
      const countBadge = e.count > 1 ? `<span style="color:var(--red);font-size:0.6rem;font-weight:bold;">×${e.count}</span> ` : '';
      html += `<div style="font-size:0.7rem;padding:3px 0 3px 18px;color:var(--text);border-left:2px solid rgba(255,45,85,0.3);margin:2px 0;">
        ${countBadge}<span style="color:var(--text-dim);">[${e.source}]</span> ${e.message.length > 120 ? e.message.substring(0,120) + '…' : e.message}
      </div>`;
    });
    html += '</div>';
  }

  html += '<div class="infra-grid">';

  // ── Data Flow (THE critical check — would have caught today's bug)
  html += '<div>';
  html += '<div class="infra-group-title">Data Flow Pipeline</div>';
  if (data.dataFlow) {
    const df = data.dataFlow;
    const flowDot = df.isFlowing ? 'up' : 'down';
    const flowLabel = df.isFlowing ? 'DATA FLOWING' : 'DATA NOT FLOWING';
    const flowColor = df.isFlowing ? 'var(--green)' : 'var(--red)';
    const staleStr = df.secondsSinceLastInsert > 0 ? formatDuration(df.secondsSinceLastInsert) + ' ago' : 'just now';
    html += `<div class="infra-item">
      <div class="infra-dot ${flowDot}"></div>
      <div class="infra-item-name" style="color:${flowColor};font-weight:bold;">${flowLabel}</div>
    </div>`;
    html += `<div class="infra-app-grid" style="margin-top:6px;">
      <div class="infra-app-stat">
        <div class="infra-app-val" style="${df.hitsLast5Min === 0 && !df.isFlowing ? 'color:var(--red)' : ''}">${df.hitsLast5Min}</div>
        <div class="infra-app-lbl">LAST 5 MIN</div>
      </div>
      <div class="infra-app-stat">
        <div class="infra-app-val">${df.hitsLastHour}</div>
        <div class="infra-app-lbl">LAST HOUR</div>
      </div>
      <div class="infra-app-stat">
        <div class="infra-app-val" style="font-size:0.7rem;">${staleStr}</div>
        <div class="infra-app-lbl">LAST INSERT</div>
      </div>
      <div class="infra-app-stat">
        <div class="infra-app-val" style="${df.queueDepth > 100 ? 'color:var(--yellow)' : ''}">${df.queueDepth}</div>
        <div class="infra-app-lbl">QUEUE</div>
      </div>
      <div class="infra-app-stat">
        <div class="infra-app-val" style="${df.etlLag > 50 ? 'color:var(--yellow)' : ''}">${df.etlLag}</div>
        <div class="infra-app-lbl">ETL LAG</div>
      </div>
      <div class="infra-app-stat">
        <div class="infra-app-val">${num(df.maxTestId)}</div>
        <div class="infra-app-lbl">MAX TEST ID</div>
      </div>
    </div>`;
    if (df.error) {
      html += `<div style="font-size:0.7rem;color:var(--red);padding:4px 0 0 18px;">${df.error}</div>`;
    }
  }
  html += '</div>';

  // ── Windows Services
  html += '<div>';
  html += '<div class="infra-group-title">Windows Services</div>';
  if (data.services && data.services.length) {
    data.services.forEach(s => {
      const dotCls = s.isRunning ? 'up' : 'down';
      const detail = s.isRunning ? s.status : (s.error || s.status);
      const critTag = s.critical ? ' <span style="color:var(--red);font-size:0.55rem;">CRITICAL</span>' : '';
      html += `<div class="infra-item">
        <div class="infra-dot ${dotCls}"></div>
        <div class="infra-item-name">${s.name}${critTag}</div>
        <div class="infra-item-detail">${detail}</div>
      </div>`;
    });
  } else {
    html += '<div style="color:var(--text-dim);font-size:0.7rem;">No service data</div>';
  }
  html += '</div>';

  // ── Websites
  html += '<div>';
  html += '<div class="infra-group-title">Website Endpoints</div>';
  if (data.websites && data.websites.length) {
    data.websites.forEach(w => {
      const dotCls = w.isHealthy ? 'up' : 'down';
      const statusTxt = w.isHealthy ? `${w.statusCode} OK` : (w.error || `HTTP ${w.statusCode}`);
      const critTag = w.critical ? ' <span style="color:var(--red);font-size:0.55rem;">CRITICAL</span>' : '';
      html += `<div class="infra-item">
        <div class="infra-dot ${dotCls}"></div>
        <div class="infra-item-name">${w.name}${critTag}</div>
        <div class="infra-item-detail">${statusTxt}</div>
        <div class="infra-item-ms">${w.responseMs}ms</div>
      </div>`;
    });
  } else {
    html += '<div style="color:var(--text-dim);font-size:0.7rem;">No website data</div>';
  }
  html += '</div>';

  // ── SQL Server
  html += '<div>';
  html += '<div class="infra-group-title">SQL Server</div>';
  if (data.sql) {
    const s = data.sql;
    const dotCls = s.isConnected ? 'up' : 'down';
    html += `<div class="infra-item">
      <div class="infra-dot ${dotCls}"></div>
      <div class="infra-item-name">${s.dataSource || 'SQL Server'} / ${s.database || '?'}</div>
      <div class="infra-item-ms">${s.responseMs}ms</div>
    </div>`;
    if (s.isConnected) {
      html += `<div style="font-size:0.7rem;color:var(--text-dim);padding:4px 0 0 18px;">
        PiXL.Test: ${num(s.testRows)} rows · PiXL.Parsed: ${num(s.parsedRows)} rows · Watermark: ${num(s.watermark)}
      </div>`;
      if (s.lastEtlRun) {
        html += `<div style="font-size:0.65rem;color:var(--text-dim);padding:2px 0 0 18px;">Last ETL: ${timeAgo(s.lastEtlRun)}</div>`;
      }
    } else {
      html += `<div style="font-size:0.7rem;color:var(--red);padding:4px 0 0 18px;">${s.error || 'Connection failed'}</div>`;
    }
  }
  html += '</div>';

  // ── App Runtime
  html += '<div>';
  html += '<div class="infra-group-title">App Runtime</div>';
  if (data.app) {
    const a = data.app;
    const uptimeSec = a.uptime ? (a.uptime.totalSeconds || 
      (a.uptime.hours * 3600 + a.uptime.minutes * 60 + a.uptime.seconds) ||
      0) : 0;
    const uptimeStr = uptimeSec > 86400 ? Math.floor(uptimeSec/86400) + 'd ' + Math.floor((uptimeSec%86400)/3600) + 'h' :
                      uptimeSec > 3600 ? Math.floor(uptimeSec/3600) + 'h ' + Math.floor((uptimeSec%3600)/60) + 'm' :
                      Math.floor(uptimeSec/60) + 'm';
    html += `<div class="infra-app-grid">
      <div class="infra-app-stat">
        <div class="infra-app-val">${a.processId}</div>
        <div class="infra-app-lbl">PID</div>
      </div>
      <div class="infra-app-stat">
        <div class="infra-app-val">${uptimeStr}</div>
        <div class="infra-app-lbl">UPTIME</div>
      </div>
      <div class="infra-app-stat">
        <div class="infra-app-val">${a.workingSetMB}</div>
        <div class="infra-app-lbl">MEM (MB)</div>
      </div>
      <div class="infra-app-stat">
        <div class="infra-app-val">${a.threadCount}</div>
        <div class="infra-app-lbl">THREADS</div>
      </div>
      <div class="infra-app-stat">
        <div class="infra-app-val">${a.gcHeapMB}</div>
        <div class="infra-app-lbl">GC HEAP</div>
      </div>
      <div class="infra-app-stat">
        <div class="infra-app-val" style="${a.queueDepth > 100 ? 'color:var(--yellow)' : ''}">${a.queueDepth}</div>
        <div class="infra-app-lbl">WRITE QUEUE</div>
      </div>
    </div>`;
    html += `<div style="font-size:0.6rem;color:var(--text-dim);margin-top:6px;">${a.machineName} · .NET ${a.dotNetVersion}</div>`;
  }
  html += '</div>';

  html += '</div>'; // close infra-grid
  el.innerHTML = html;

  // ── Update the header beacon based on infra status (overrides the hit-staleness beacon)
  if (status === 'critical') {
    document.getElementById('beacon').className = 'beacon-dot danger';
    document.getElementById('system-status').textContent = 'CRITICAL — CHECK INFRA';
  }
}

// ============================================================================
// HELPERS
// ============================================================================
function num(n) {
  if (n == null) return '--';
  return Number(n).toLocaleString();
}

function formatDuration(sec) {
  if (sec < 60) return sec + 's';
  if (sec < 3600) return Math.floor(sec/60) + 'm';
  if (sec < 86400) return Math.floor(sec/3600) + 'h ' + Math.floor((sec%3600)/60) + 'm';
  return Math.floor(sec/86400) + 'd';
}

function timeAgo(dt) {
  const d = new Date(dt);
  const sec = Math.floor((Date.now() - d.getTime()) / 1000);
  if (sec < 60) return sec + 's ago';
  if (sec < 3600) return Math.floor(sec/60) + 'm ago';
  return Math.floor(sec/3600) + 'h ago';
}

// ============================================================================
// REFRESH LOOP
// ============================================================================
const REFRESH_INTERVAL = 10; // seconds
let countdown = REFRESH_INTERVAL;

async function refreshAll() {
  const [health, hourly, bots, signals, evasion, behavior, recent, fingerprints, devices, infra] =
    await Promise.all([
      API.health(), API.hourly(48), API.bots(), API.signals(),
      API.evasion(), API.behavior(), API.recent(), API.fingerprints(), API.devices(),
      API.infra()
    ]);

  renderHero(health);
  renderHourlyChart(hourly);
  renderRiskList(bots);
  renderSignals(signals);
  renderEvasion(evasion);
  renderBehavior(behavior);
  renderLiveFeed(recent);
  renderFingerprints(fingerprints);
  renderDevices(devices);
  renderInfra(infra);

  countdown = REFRESH_INTERVAL;
}

// UTC clock
setInterval(() => {
  const now = new Date();
  document.getElementById('utc-clock').textContent =
    now.toISOString().substring(11, 19);
  
  countdown--;
  document.getElementById('countdown').textContent = Math.max(0, countdown);
  if (countdown <= 0) {
    refreshAll();
  }
}, 1000);

// Initial load
refreshAll();
</script>
</body>
</html>
