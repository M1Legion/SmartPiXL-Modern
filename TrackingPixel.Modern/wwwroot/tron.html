<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartPiXL // TRON</title>
<style>
/* ============================================================================
   TRON AESTHETIC — Single-Page App: Operations + Analytics
   Canvas, header, nav, and modal persist across view switches.
   ============================================================================ */
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;900&family=Share+Tech+Mono&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #030810;
  --bg2: #060e1a;
  --panel: rgba(6, 20, 40, 0.85);
  --panel-border: rgba(0, 243, 255, 0.2);
  --panel-glow: rgba(0, 243, 255, 0.05);
  --cyan: #00f3ff;
  --cyan-dim: rgba(0, 243, 255, 0.5);
  --cyan-ghost: rgba(0, 243, 255, 0.08);
  --orange: #ff6a00;
  --orange-dim: rgba(255, 106, 0, 0.5);
  --red: #ff2d55;
  --red-dim: rgba(255, 45, 85, 0.5);
  --green: #00ff88;
  --green-dim: rgba(0, 255, 136, 0.5);
  --yellow: #ffe14d;
  --text: #d4eeff;
  --text-dim: rgba(160, 200, 230, 0.7);
  --mono: 'Share Tech Mono', 'Consolas', monospace;
  --display: 'Orbitron', sans-serif;
}

html { font-size: 16px; }

body {
  font-family: var(--mono);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}

/* Scan lines */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,243,255,0.018) 2px, rgba(0,243,255,0.018) 4px);
  pointer-events: none;
  z-index: 9999;
}

/* Grid background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    linear-gradient(rgba(0,243,255,0.035) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,243,255,0.035) 1px, transparent 1px);
  background-size: 60px 60px;
  pointer-events: none;
  z-index: 0;
}

#grid-canvas { position: fixed; inset: 0; z-index: 0; pointer-events: none; }

.vignette {
  position: fixed;
  inset: 0;
  background: radial-gradient(ellipse at center, transparent 50%, rgba(3,8,16,0.6) 100%);
  pointer-events: none;
  z-index: 0;
}

.dashboard {
  position: relative;
  z-index: 1;
  max-width: 1800px;
  margin: 0 auto;
  padding: 16px 24px;
}

/* View toggle */
.view-content { display: none; }
.view-content.active { display: block; }

/* ─── HEADER ─── */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0 20px;
  border-bottom: 1px solid var(--panel-border);
  margin-bottom: 24px;
}

.header-left { display: flex; align-items: center; gap: 16px; }

.logo {
  font-family: var(--display);
  font-size: 1.6rem;
  font-weight: 900;
  letter-spacing: 6px;
  text-transform: uppercase;
  color: var(--cyan);
  text-shadow: 0 0 20px var(--cyan-dim), 0 0 60px rgba(0,243,255,0.2);
  animation: logoGlow 4s ease-in-out infinite;
}

@keyframes logoGlow {
  0%, 100% { text-shadow: 0 0 20px var(--cyan-dim), 0 0 60px rgba(0,243,255,0.2); }
  50% { text-shadow: 0 0 30px var(--cyan), 0 0 80px rgba(0,243,255,0.4), 0 0 120px rgba(0,243,255,0.15); }
}

.logo-sub {
  font-family: var(--mono);
  font-size: 0.78rem;
  color: var(--text-dim);
  letter-spacing: 3px;
  text-transform: uppercase;
}

.status-beacon {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.82rem;
  font-weight: 500;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.beacon-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 10px var(--green), 0 0 25px var(--green-dim), 0 0 50px rgba(0,255,136,0.15);
  animation: pulse 2s ease-in-out infinite;
}

.beacon-dot.warn { background: var(--yellow); box-shadow: 0 0 10px var(--yellow), 0 0 25px rgba(255,225,77,0.4), 0 0 50px rgba(255,225,77,0.15); }
.beacon-dot.danger { background: var(--red); box-shadow: 0 0 10px var(--red), 0 0 25px var(--red-dim), 0 0 50px rgba(255,45,85,0.15); animation: pulse 0.8s ease-in-out infinite; }

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.4; transform: scale(0.8); }
}

.header-right {
  display: flex;
  align-items: center;
  gap: 20px;
  font-size: 0.78rem;
  color: var(--text-dim);
}

.refresh-timer { font-family: var(--mono); color: var(--cyan-dim); }

/* ─── NAV ─── */
.nav-bar {
  display: flex;
  gap: 2px;
  margin-bottom: 24px;
}

.nav-tab {
  font-family: var(--display);
  font-size: 0.72rem;
  font-weight: 500;
  letter-spacing: 3px;
  text-transform: uppercase;
  padding: 10px 24px;
  background: var(--panel);
  border: 1px solid var(--panel-border);
  color: var(--text-dim);
  text-decoration: none;
  transition: all 0.2s;
  cursor: pointer;
  user-select: none;
}

.nav-tab:first-child { border-radius: 4px 0 0 4px; }
.nav-tab:last-child { border-radius: 0 4px 4px 0; }

.nav-tab:hover {
  color: var(--cyan);
  border-color: var(--cyan-dim);
  background: rgba(0,243,255,0.05);
}

.nav-tab.active {
  color: var(--cyan);
  border-color: var(--cyan);
  background: rgba(0,243,255,0.1);
  box-shadow: 0 0 15px var(--panel-glow), 0 0 30px rgba(0,243,255,0.03);
}

/* ─── PANELS ─── */
.panel-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
  margin-bottom: 24px;
}

.panel-grid.triple { grid-template-columns: 1fr 1fr 1fr; }
.panel-grid.half { grid-template-columns: 1fr 1fr; }

.panel {
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 4px;
  padding: 20px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.3s, box-shadow 0.3s;
}

.panel::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--cyan-dim), transparent);
  opacity: 0.6;
  transition: opacity 0.3s;
}

.panel:hover {
  border-color: rgba(0,243,255,0.35);
  box-shadow: 0 0 25px rgba(0,243,255,0.06), inset 0 0 25px rgba(0,243,255,0.02);
}

.panel:hover::before { opacity: 1; }

.panel-title {
  font-family: var(--display);
  font-size: 0.8rem;
  font-weight: 600;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--cyan);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.panel-title::before { content: '//'; color: var(--text-dim); }

/* ─── PIPELINE (shared) ─── */
.pipeline {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0;
  padding: 12px 0;
}

.pipe-node {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  padding: 12px 16px;
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 4px;
  min-width: 110px;
  transition: all 0.3s;
  cursor: pointer;
}

.pipe-node:hover {
  border-color: rgba(0,243,255,0.5);
  box-shadow: 0 0 25px rgba(0,243,255,0.1);
}

.pipe-node.healthy { border-color: rgba(0,255,136,0.3); }
.pipe-node.healthy:hover { box-shadow: 0 0 25px rgba(0,255,136,0.1); }
.pipe-node.stale { border-color: rgba(255,225,77,0.3); background: rgba(255,225,77,0.03); }
.pipe-node.down { border-color: rgba(255,45,85,0.3); background: rgba(255,45,85,0.03); }

.pipe-node-label {
  font-family: var(--display);
  font-size: 0.6rem;
  font-weight: 500;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--cyan);
}

.pipe-node-value { font-family: var(--display); font-size: 0.9rem; font-weight: 700; }
.pipe-node-sub { font-size: 0.65rem; color: var(--text-dim); }

.pipe-arrow {
  width: 30px;
  height: 2px;
  background: linear-gradient(90deg, var(--cyan-dim), var(--cyan));
  position: relative;
  animation: dataFlow 2s linear infinite;
}

.pipe-arrow.dead {
  background: linear-gradient(90deg, var(--red-dim), var(--red));
  animation: none;
  opacity: 0.4;
}

.pipe-arrow::after {
  content: '';
  position: absolute;
  right: -5px; top: -4px;
  width: 0; height: 0;
  border-left: 7px solid var(--cyan);
  border-top: 5px solid transparent;
  border-bottom: 5px solid transparent;
}

.pipe-arrow.dead::after { border-left-color: var(--red); }

.pipe-arrow::before {
  content: '';
  position: absolute;
  width: 6px;
  height: 6px;
  top: -2px;
  border-radius: 50%;
  background: var(--cyan);
  box-shadow: 0 0 8px var(--cyan), 0 0 16px var(--cyan-dim);
  animation: arrowParticle 2s linear infinite;
}

.pipe-arrow.dead::before { display: none; }

@keyframes arrowParticle {
  0% { left: -6px; opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { left: 100%; opacity: 0; }
}

@keyframes dataFlow {
  0% { opacity: 0.3; }
  50% { opacity: 1; }
  100% { opacity: 0.3; }
}

/* ─── FEED TABLE (shared) ─── */
.feed-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }

.feed-table th {
  font-family: var(--display);
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--cyan-dim);
  text-align: left;
  padding: 8px 10px;
  border-bottom: 1px solid var(--panel-border);
}

.feed-table td {
  padding: 6px 10px;
  border-bottom: 1px solid rgba(0,243,255,0.05);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 180px;
}

.feed-table tr { transition: background 0.2s; cursor: pointer; }
.feed-table tr:hover { background: rgba(0,243,255,0.08); }

@keyframes rowFlash {
  0% { background: rgba(0,243,255,0.15); }
  100% { background: transparent; }
}

/* ─── BADGE (shared) ─── */
.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 2px;
  font-family: var(--display);
  font-size: 0.7rem;
  font-weight: 700;
  letter-spacing: 1px;
}

.badge.high { background: rgba(255,45,85,0.2); color: var(--red); border: 1px solid rgba(255,45,85,0.3); }
.badge.med { background: rgba(255,106,0,0.2); color: var(--orange); border: 1px solid rgba(255,106,0,0.3); }
.badge.low { background: rgba(255,225,77,0.15); color: var(--yellow); border: 1px solid rgba(255,225,77,0.2); }
.badge.ok { background: rgba(0,255,136,0.1); color: var(--green); border: 1px solid rgba(0,255,136,0.2); }

/* ─── LOADING (shared) ─── */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
  color: var(--text-dim);
  font-size: 0.78rem;
  letter-spacing: 3px;
}

.loading::after {
  content: '';
  width: 16px; height: 16px;
  border: 2px solid var(--panel-border);
  border-top-color: var(--cyan);
  border-radius: 50%;
  margin-left: 12px;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ─── MODAL (shared) ─── */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(3, 8, 16, 0.88);
  backdrop-filter: blur(6px);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s;
}

.modal-overlay.active { opacity: 1; pointer-events: all; }

.modal-panel {
  background: var(--bg2);
  border: 1px solid var(--cyan-dim);
  border-radius: 6px;
  padding: 28px;
  max-width: 800px;
  width: 92%;
  max-height: 82vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 0 60px rgba(0,243,255,0.12), 0 0 120px rgba(0,243,255,0.04);
  transform: scale(0.95);
  transition: transform 0.3s;
}

.modal-overlay.active .modal-panel { transform: scale(1); }

.modal-panel::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--cyan), transparent);
}

.modal-close {
  position: absolute;
  top: 12px; right: 12px;
  background: none;
  border: 1px solid var(--panel-border);
  color: var(--text-dim);
  width: 32px;
  height: 32px;
  cursor: pointer;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 3px;
  transition: all 0.2s;
  font-family: var(--mono);
}

.modal-close:hover {
  color: var(--cyan);
  border-color: var(--cyan-dim);
  box-shadow: 0 0 12px rgba(0,243,255,0.1);
}

.modal-title {
  font-family: var(--display);
  font-size: 0.85rem;
  font-weight: 600;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--cyan);
  margin-bottom: 20px;
  padding-right: 40px;
}

.modal-title::before { content: '// '; color: var(--text-dim); }

.modal-body { font-size: 0.82rem; line-height: 1.6; }

.modal-body .detail-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-top: 12px;
}

.modal-body .detail-item {
  padding: 10px 14px;
  background: rgba(0,243,255,0.03);
  border: 1px solid rgba(0,243,255,0.08);
  border-radius: 4px;
}

.modal-body .detail-label {
  font-family: var(--display);
  font-size: 0.65rem;
  font-weight: 500;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-bottom: 4px;
}

.modal-body .detail-value {
  font-family: var(--mono);
  font-size: 0.88rem;
  color: var(--text);
}

.modal-body .detail-value.ok { color: var(--green); }
.modal-body .detail-value.bad { color: var(--red); }
.modal-body .detail-value.warn { color: var(--yellow); }
.modal-body .detail-value.cyan { color: var(--cyan); }

.modal-body .full-text {
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--panel-border);
  border-radius: 4px;
  padding: 14px;
  margin-top: 12px;
  white-space: pre-wrap;
  word-break: break-word;
  font-size: 0.8rem;
  line-height: 1.5;
  max-height: 300px;
  overflow-y: auto;
}

.modal-body .suggestion {
  margin-top: 16px;
  padding: 12px 16px;
  background: rgba(0,243,255,0.04);
  border: 1px solid rgba(0,243,255,0.15);
  border-radius: 4px;
  font-size: 0.78rem;
  line-height: 1.5;
  color: var(--text);
}

.modal-body .suggestion-title {
  font-family: var(--display);
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 2px;
  color: var(--cyan);
  margin-bottom: 8px;
}

/* ============================================================================
   OPERATIONS VIEW — Critical Zone, Status Strip, Infra, Error Log, ETL
   ============================================================================ */

/* Critical Issues Zone */
#critical-zone { margin-bottom: 24px; }
#critical-zone.slide-in { animation: criticalSlideIn 0.4s ease-out; }

@keyframes criticalSlideIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.critical-panel {
  background: rgba(255, 45, 85, 0.04);
  border: 1px solid rgba(255, 45, 85, 0.4);
  border-radius: 4px;
  padding: 20px;
  position: relative;
  overflow: hidden;
}

.critical-panel::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--red), var(--orange), var(--red), transparent);
  animation: criticalGlow 2s ease-in-out infinite;
}

@keyframes criticalGlow {
  0%, 100% { opacity: 0.6; }
  50% { opacity: 1; }
}

.critical-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }

.critical-icon {
  width: 22px; height: 22px; border-radius: 50%;
  background: var(--red);
  box-shadow: 0 0 14px var(--red-dim), 0 0 35px rgba(255,45,85,0.25);
  animation: pulse 0.8s ease-in-out infinite;
  flex-shrink: 0;
}

.critical-icon.warning {
  background: var(--yellow);
  box-shadow: 0 0 14px rgba(255,225,77,0.5), 0 0 35px rgba(255,225,77,0.2);
  animation: pulse 2s ease-in-out infinite;
}

.critical-title {
  font-family: var(--display);
  font-size: 0.82rem;
  font-weight: 600;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--red);
}

.critical-title.warning { color: var(--yellow); }

.critical-count {
  margin-left: auto;
  font-family: var(--display);
  font-size: 0.72rem;
  font-weight: 500;
  letter-spacing: 2px;
  color: var(--text-dim);
}

.critical-issue {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 10px 14px;
  margin-bottom: 4px;
  border-radius: 4px;
  border-left: 3px solid var(--red);
  background: rgba(255, 45, 85, 0.06);
  transition: background 0.2s;
  cursor: pointer;
}

.critical-issue:hover { background: rgba(255, 45, 85, 0.12); }
.critical-issue.warning { border-left-color: var(--yellow); background: rgba(255, 225, 77, 0.04); }
.critical-issue.warning:hover { background: rgba(255, 225, 77, 0.1); }

.issue-severity {
  font-family: var(--display);
  font-size: 0.65rem;
  font-weight: 600;
  letter-spacing: 1px;
  padding: 2px 8px;
  border-radius: 2px;
  flex-shrink: 0;
  margin-top: 1px;
}

.issue-severity.critical { background: rgba(255,45,85,0.2); color: var(--red); border: 1px solid rgba(255,45,85,0.3); }
.issue-severity.warning { background: rgba(255,225,77,0.15); color: var(--yellow); border: 1px solid rgba(255,225,77,0.2); }

.issue-body { flex: 1; min-width: 0; }
.issue-title { font-size: 0.88rem; font-weight: bold; color: var(--text); margin-bottom: 3px; }
.issue-detail { font-size: 0.78rem; color: var(--text-dim); line-height: 1.5; }
.issue-time { font-size: 0.7rem; color: var(--text-dim); flex-shrink: 0; text-align: right; }

/* Status Strip */
.status-strip { display: flex; gap: 3px; margin-bottom: 24px; flex-wrap: wrap; }

.status-chip {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 4px;
  flex: 1;
  min-width: 140px;
  transition: all 0.3s;
  cursor: pointer;
}

.status-chip:hover { border-color: rgba(0,243,255,0.4); box-shadow: 0 0 20px rgba(0,243,255,0.08); }
.status-chip.healthy { border-color: rgba(0,255,136,0.3); }
.status-chip.healthy:hover { border-color: rgba(0,255,136,0.5); box-shadow: 0 0 20px rgba(0,255,136,0.1); }
.status-chip.degraded { border-color: rgba(255,225,77,0.3); background: rgba(255,225,77,0.03); }
.status-chip.degraded:hover { border-color: rgba(255,225,77,0.5); box-shadow: 0 0 20px rgba(255,225,77,0.1); }
.status-chip.critical { border-color: rgba(255,45,85,0.3); background: rgba(255,45,85,0.03); }
.status-chip.critical:hover { border-color: rgba(255,45,85,0.5); box-shadow: 0 0 20px rgba(255,45,85,0.1); }

.chip-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
.chip-dot.up { background: var(--green); box-shadow: 0 0 8px var(--green-dim); }
.chip-dot.down { background: var(--red); box-shadow: 0 0 8px var(--red-dim); animation: pulse 0.8s ease-in-out infinite; }
.chip-dot.warn { background: var(--yellow); box-shadow: 0 0 8px rgba(255,225,77,0.4); }
.chip-dot.idle { background: var(--text-dim); }

.chip-label {
  font-family: var(--display);
  font-size: 0.65rem;
  font-weight: 500;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: var(--text-dim);
}

.chip-value { margin-left: auto; font-family: var(--mono); font-size: 0.78rem; color: var(--text); }
.chip-value.ok { color: var(--green); }
.chip-value.bad { color: var(--red); }
.chip-value.warn { color: var(--yellow); }

/* Error Log */
.error-log { font-size: 0.82rem; }

.error-entry {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 8px 12px;
  margin-bottom: 3px;
  border-radius: 3px;
  border-left: 2px solid rgba(255,45,85,0.4);
  background: rgba(255,45,85,0.04);
  transition: background 0.2s;
  cursor: pointer;
}

.error-entry:hover { background: rgba(255,45,85,0.1); }
.error-entry.stale { border-left-color: rgba(255,225,77,0.3); background: rgba(255,225,77,0.02); opacity: 0.6; }

.error-source {
  font-family: var(--display);
  font-size: 0.65rem;
  font-weight: 500;
  letter-spacing: 1px;
  color: var(--text-dim);
  width: 80px;
  flex-shrink: 0;
  text-transform: uppercase;
}

.error-msg { flex: 1; color: var(--text); word-break: break-word; }
.error-msg.stale { color: var(--text-dim); }

.error-count { font-family: var(--display); font-size: 0.7rem; font-weight: 600; color: var(--red); flex-shrink: 0; }
.error-age { font-size: 0.7rem; color: var(--text-dim); flex-shrink: 0; width: 60px; text-align: right; }

/* ETL Grid */
.etl-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

.etl-stat {
  text-align: center;
  padding: 12px 8px;
  background: rgba(0,243,255,0.03);
  border: 1px solid rgba(0,243,255,0.08);
  border-radius: 4px;
}

.etl-val { font-family: var(--display); font-size: 1.1rem; font-weight: 700; color: var(--cyan); text-shadow: 0 0 10px rgba(0,243,255,0.2); }
.etl-val.warn { color: var(--yellow); text-shadow: 0 0 10px rgba(255,225,77,0.2); }
.etl-val.bad { color: var(--red); text-shadow: 0 0 10px rgba(255,45,85,0.2); }
.etl-lbl { font-size: 0.65rem; font-weight: 500; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; margin-top: 4px; }

/* Infra Grid */
.infra-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

.infra-group-title {
  font-family: var(--display);
  font-size: 0.7rem;
  font-weight: 600;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--cyan-dim);
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--panel-border);
}

.infra-item { display: flex; align-items: center; gap: 10px; padding: 6px 0; font-size: 0.82rem; }

.infra-dot { width: 9px; height: 9px; border-radius: 50%; flex-shrink: 0; }
.infra-dot.up { background: var(--green); box-shadow: 0 0 6px var(--green-dim); }
.infra-dot.down { background: var(--red); box-shadow: 0 0 6px var(--red-dim); }
.infra-dot.warn { background: var(--yellow); box-shadow: 0 0 6px rgba(255,225,77,0.3); }

.infra-item-name { flex: 1; }
.infra-item-detail { font-size: 0.72rem; color: var(--text-dim); text-align: right; }
.infra-item-ms { font-family: var(--display); font-size: 0.72rem; font-weight: 500; color: var(--cyan-dim); width: 50px; text-align: right; }

.infra-app-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 8px; }

.infra-app-stat {
  text-align: center;
  padding: 8px 4px;
  background: rgba(0,243,255,0.03);
  border: 1px solid rgba(0,243,255,0.06);
  border-radius: 3px;
}

.infra-app-val { font-family: var(--display); font-size: 0.9rem; font-weight: 700; color: var(--cyan); }
.infra-app-lbl { font-size: 0.65rem; font-weight: 500; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }

/* All-Clear Banner */
.all-clear {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px 22px;
  background: rgba(0,255,136,0.04);
  border: 1px solid rgba(0,255,136,0.2);
  border-radius: 4px;
  box-shadow: 0 0 30px rgba(0,255,136,0.04);
  animation: allClearPulse 4s ease-in-out infinite;
}

@keyframes allClearPulse {
  0%, 100% { box-shadow: 0 0 30px rgba(0,255,136,0.04); }
  50% { box-shadow: 0 0 50px rgba(0,255,136,0.08), 0 0 80px rgba(0,255,136,0.03); }
}

.all-clear-dot {
  width: 14px; height: 14px; border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 12px var(--green-dim), 0 0 30px rgba(0,255,136,0.2);
  animation: pulse 3s ease-in-out infinite;
}

.all-clear-text {
  font-family: var(--display);
  font-size: 0.82rem;
  font-weight: 600;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--green);
  text-shadow: 0 0 15px rgba(0,255,136,0.3);
}

.all-clear-sub { margin-left: auto; font-size: 0.72rem; color: var(--text-dim); }

/* ============================================================================
   ANALYTICS VIEW — Hero Cards, Charts, Signals, Evasion, Behavior, FP, Devices
   ============================================================================ */

/* Hero Cards */
.hero-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px; }

.hero-card {
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 4px;
  padding: 16px 20px;
  position: relative;
  overflow: hidden;
  transition: border-color 0.3s, box-shadow 0.3s;
  cursor: pointer;
}

.hero-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--cyan), transparent);
  opacity: 0.6;
  transition: opacity 0.3s;
}

.hero-card:hover { border-color: var(--cyan-dim); box-shadow: 0 0 30px var(--panel-glow), inset 0 0 30px var(--panel-glow); }
.hero-card:hover::before { opacity: 1; }

.hero-label {
  font-family: var(--display);
  font-size: 0.65rem;
  font-weight: 500;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--text-dim);
  margin-bottom: 8px;
}

.hero-value {
  font-family: var(--display);
  font-size: 2rem;
  font-weight: 700;
  color: var(--cyan);
  text-shadow: 0 0 20px var(--cyan-dim);
  line-height: 1;
}

.hero-value.warn { color: var(--yellow); text-shadow: 0 0 20px rgba(255,225,77,0.3); }
.hero-value.danger { color: var(--red); text-shadow: 0 0 20px var(--red-dim); }
.hero-value.good { color: var(--green); text-shadow: 0 0 20px var(--green-dim); }

.hero-sub { font-size: 0.72rem; color: var(--text-dim); margin-top: 6px; }

/* Hourly Chart */
.chart-container { height: 200px; display: flex; align-items: flex-end; gap: 2px; padding-top: 10px; }

.chart-bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; min-width: 0; cursor: pointer; transition: opacity 0.2s; }
.chart-bar-group:hover { opacity: 0.8; }

.chart-bar { width: 100%; min-height: 1px; border-radius: 1px 1px 0 0; transition: height 0.6s ease; }
.chart-bar.human { background: linear-gradient(to top, rgba(0,243,255,0.3), rgba(0,243,255,0.7)); box-shadow: 0 0 8px rgba(0,243,255,0.3); }
.chart-bar.bot { background: linear-gradient(to top, rgba(255,45,85,0.3), rgba(255,45,85,0.7)); box-shadow: 0 0 8px rgba(255,45,85,0.3); }

.chart-label { font-size: 0.6rem; color: var(--text-dim); writing-mode: vertical-rl; transform: rotate(180deg); max-height: 50px; overflow: hidden; }

/* Risk Gauge */
.risk-list { display: flex; flex-direction: column; gap: 12px; }

.risk-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 12px;
  border-radius: 4px;
  border: 1px solid transparent;
  transition: all 0.2s;
  cursor: pointer;
}

.risk-row:hover { border-color: var(--panel-border); background: var(--cyan-ghost); }

.risk-indicator { width: 6px; height: 32px; border-radius: 3px; flex-shrink: 0; }
.risk-indicator.high { background: var(--red); box-shadow: 0 0 10px var(--red-dim); }
.risk-indicator.medium { background: var(--orange); box-shadow: 0 0 10px var(--orange-dim); }
.risk-indicator.low { background: var(--yellow); box-shadow: 0 0 8px rgba(255,225,77,0.3); }
.risk-indicator.ok { background: var(--green); box-shadow: 0 0 8px var(--green-dim); }

.risk-info { flex: 1; }
.risk-label { font-size: 0.82rem; letter-spacing: 1px; }
.risk-count { font-family: var(--display); font-size: 1.3rem; font-weight: 700; text-shadow: 0 0 10px rgba(0,243,255,0.15); }
.risk-meta { font-size: 0.72rem; color: var(--text-dim); }

/* Signal Bars */
.signal-list { display: flex; flex-direction: column; gap: 8px; }
.signal-row { display: flex; align-items: center; gap: 10px; cursor: pointer; }
.signal-row:hover .signal-bar-fill { box-shadow: 0 0 16px var(--cyan-dim); }

.signal-name { width: 180px; flex-shrink: 0; font-size: 0.78rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.signal-bar-track { flex: 1; height: 16px; background: rgba(0,243,255,0.05); border-radius: 2px; overflow: hidden; }

.signal-bar-fill {
  height: 100%;
  border-radius: 2px;
  background: linear-gradient(90deg, var(--cyan-dim), var(--cyan));
  box-shadow: 0 0 10px var(--cyan-dim);
  transition: width 0.8s ease, box-shadow 0.3s;
  position: relative;
}

.signal-bar-fill::after {
  content: '';
  position: absolute;
  right: 0; top: 0; bottom: 0;
  width: 2px;
  background: var(--cyan);
  box-shadow: 0 0 8px var(--cyan);
}

.signal-count { width: 50px; text-align: right; font-size: 0.78rem; color: var(--cyan); }

/* Evasion Grid */
.evasion-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }

.evasion-card {
  text-align: center;
  padding: 12px;
  background: rgba(0,243,255,0.03);
  border: 1px solid rgba(0,243,255,0.08);
  border-radius: 4px;
  transition: border-color 0.3s, box-shadow 0.3s;
  cursor: pointer;
}

.evasion-card:hover { border-color: rgba(0,243,255,0.2); box-shadow: 0 0 15px rgba(0,243,255,0.05); }

.evasion-val { font-family: var(--display); font-size: 1.4rem; font-weight: 700; color: var(--cyan); text-shadow: 0 0 10px rgba(0,243,255,0.2); }
.evasion-val.alert { color: var(--red); text-shadow: 0 0 12px var(--red-dim); }
.evasion-lbl { font-size: 0.65rem; font-weight: 500; color: var(--text-dim); letter-spacing: 1px; text-transform: uppercase; margin-top: 4px; }

/* Behavior */
.behavior-compare { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
.behavior-col { text-align: center; }
.behavior-col-title {
  font-family: var(--display);
  font-size: 0.72rem;
  font-weight: 600;
  letter-spacing: 3px;
  text-transform: uppercase;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--panel-border);
}

.behavior-col-title.human { color: var(--cyan); }
.behavior-col-title.bot { color: var(--red); }
.behavior-stat { display: flex; justify-content: space-between; padding: 5px 8px; font-size: 0.78rem; }
.behavior-stat .val { font-weight: bold; }

/* Fingerprint Clusters */
.fp-cluster-list { display: flex; flex-direction: column; gap: 6px; }

.fp-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 7px 10px;
  border-radius: 3px;
  border: 1px solid transparent;
  transition: all 0.2s;
  font-size: 0.78rem;
  cursor: pointer;
}

.fp-row:hover { border-color: var(--panel-border); background: var(--cyan-ghost); }

.fp-hash { font-family: var(--mono); color: var(--cyan); width: 100px; flex-shrink: 0; }
.fp-meta { flex: 1; color: var(--text-dim); }
.fp-hits { font-family: var(--display); font-weight: 700; color: var(--text); }

/* ─── RESPONSIVE ─── */
@media (max-width: 1400px) {
  .hero-grid { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 1200px) {
  .status-strip { flex-wrap: wrap; }
  .status-chip { min-width: 120px; }
}

@media (max-width: 900px) {
  .hero-grid { grid-template-columns: repeat(2, 1fr); }
  .panel-grid, .panel-grid.triple, .panel-grid.half { grid-template-columns: 1fr; }
  .infra-grid { grid-template-columns: 1fr; }
  .infra-app-grid { grid-template-columns: repeat(2, 1fr); }
  .etl-grid { grid-template-columns: repeat(2, 1fr); }
  .evasion-grid { grid-template-columns: repeat(2, 1fr); }
  .pipeline { flex-wrap: wrap; gap: 8px; }
  .pipe-arrow { display: none; }
  .status-strip { gap: 8px; }
  .modal-body .detail-grid { grid-template-columns: 1fr; }
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--panel-border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--cyan-dim); }
</style>
</head>
<body>

<canvas id="grid-canvas"></canvas>
<div class="vignette"></div>

<div class="dashboard">
  <!-- ══════════════════════════════════════════════════════════════════════
       SHARED HEADER (persists across views)
       ══════════════════════════════════════════════════════════════════════ -->
  <div class="header">
    <div class="header-left">
      <div>
        <div class="logo">SMARTPIXL</div>
        <div class="logo-sub" id="logo-sub">Operations Center</div>
      </div>
      <div class="status-beacon">
        <div class="beacon-dot" id="beacon"></div>
        <span id="system-status">CONNECTING...</span>
      </div>
    </div>
    <div class="header-right">
      <div>UTC <span id="utc-clock">--:--:--</span></div>
      <div>REFRESH <span class="refresh-timer" id="countdown">10</span>s</div>
      <div id="etl-header-wrap">ETL <span id="etl-status">--</span></div>
    </div>
  </div>

  <!-- SHARED NAV (JS-driven, no page reload) -->
  <div class="nav-bar">
    <a class="nav-tab active" id="nav-ops" onclick="switchView('ops')">OPERATIONS</a>
    <a class="nav-tab" id="nav-analytics" onclick="switchView('analytics')">ANALYTICS</a>
  </div>

  <!-- ══════════════════════════════════════════════════════════════════════
       OPERATIONS VIEW
       ══════════════════════════════════════════════════════════════════════ -->
  <div id="view-ops" class="view-content active">
    <!-- Critical Issues -->
    <div id="critical-zone"></div>

    <!-- Status Strip -->
    <div class="status-strip" id="status-strip">
      <div class="status-chip"><div class="chip-dot idle"></div><div class="chip-label">OVERALL</div><div class="chip-value">--</div></div>
      <div class="status-chip"><div class="chip-dot idle"></div><div class="chip-label">DATA FLOW</div><div class="chip-value">--</div></div>
      <div class="status-chip"><div class="chip-dot idle"></div><div class="chip-label">SQL</div><div class="chip-value">--</div></div>
      <div class="status-chip"><div class="chip-dot idle"></div><div class="chip-label">IIS</div><div class="chip-value">--</div></div>
      <div class="status-chip"><div class="chip-dot idle"></div><div class="chip-label">ETL</div><div class="chip-value">--</div></div>
      <div class="status-chip"><div class="chip-dot idle"></div><div class="chip-label">LAST HIT</div><div class="chip-value">--</div></div>
    </div>

    <!-- Data Flow Pipeline -->
    <div class="pipeline-section" style="margin-bottom:24px;">
      <div class="panel">
        <div class="panel-title">DATA FLOW PIPELINE</div>
        <div class="pipeline" id="ops-pipeline">
          <div class="pipe-node" id="pipe-ingest" onclick="drillPipeline('ingest')">
            <div class="pipe-node-label">INGEST</div>
            <div class="pipe-node-value" id="pipe-ingest-val">--</div>
            <div class="pipe-node-sub" id="pipe-ingest-sub">queue</div>
          </div>
          <div class="pipe-arrow" id="pipe-arrow-1"></div>
          <div class="pipe-node" id="pipe-sql" onclick="drillPipeline('sql')">
            <div class="pipe-node-label">SQL WRITE</div>
            <div class="pipe-node-value" id="pipe-sql-val">--</div>
            <div class="pipe-node-sub" id="pipe-sql-sub">PiXL.Test</div>
          </div>
          <div class="pipe-arrow" id="pipe-arrow-2"></div>
          <div class="pipe-node" id="pipe-etl" onclick="drillPipeline('etl')">
            <div class="pipe-node-label">ETL PARSE</div>
            <div class="pipe-node-value" id="pipe-etl-val">--</div>
            <div class="pipe-node-sub" id="pipe-etl-sub">parsed</div>
          </div>
          <div class="pipe-arrow" id="pipe-arrow-3"></div>
          <div class="pipe-node" id="pipe-dash" onclick="drillPipeline('dash')">
            <div class="pipe-node-label">DASHBOARD</div>
            <div class="pipe-node-value" id="pipe-dash-val" style="font-size:0.7rem;">--</div>
            <div class="pipe-node-sub" id="pipe-dash-sub">lag</div>
          </div>
        </div>
        <div class="etl-grid" style="margin-top:12px;">
          <div class="etl-stat"><div class="etl-val" id="flow-5min">--</div><div class="etl-lbl">LAST 5 MIN</div></div>
          <div class="etl-stat"><div class="etl-val" id="flow-1hr">--</div><div class="etl-lbl">LAST HOUR</div></div>
          <div class="etl-stat"><div class="etl-val" id="flow-last-insert">--</div><div class="etl-lbl">LAST INSERT</div></div>
        </div>
      </div>
    </div>

    <!-- Errors + ETL -->
    <div class="panel-grid half">
      <div class="panel">
        <div class="panel-title">ERROR LOG</div>
        <div class="error-log" id="error-log"><div style="color:var(--text-dim); font-size:0.78rem; padding: 20px; text-align:center;">Waiting for data...</div></div>
      </div>
      <div class="panel">
        <div class="panel-title">ETL HEALTH</div>
        <div id="etl-details"><div class="loading">LOADING</div></div>
      </div>
    </div>

    <!-- Infrastructure -->
    <div class="panel" style="margin-bottom:24px;">
      <div class="panel-title">INFRASTRUCTURE</div>
      <div id="infra-detail"><div class="loading">LOADING</div></div>
    </div>

    <!-- Live Feed (compact, 15 hits) -->
    <div class="panel" style="margin-bottom:24px;">
      <div class="panel-title">LIVE FEED — LAST 15 HITS</div>
      <div style="overflow-x:auto;">
        <table class="feed-table">
          <thead><tr><th>TIME</th><th>IP</th><th>THREAT</th><th>SCORE</th><th>PLATFORM</th><th>BROWSER</th><th>FINGERPRINT</th></tr></thead>
          <tbody id="ops-feed-body"><tr><td colspan="7" class="loading">LOADING</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ══════════════════════════════════════════════════════════════════════
       ANALYTICS VIEW
       ══════════════════════════════════════════════════════════════════════ -->
  <div id="view-analytics" class="view-content">
    <!-- Hero Cards -->
    <div class="hero-grid" id="hero-grid">
      <div class="hero-card" onclick="drillHero('total')"><div class="hero-label">TOTAL HITS</div><div class="hero-value" id="h-total">--</div><div class="hero-sub" id="h-total-sub"></div></div>
      <div class="hero-card" onclick="drillHero('24h')"><div class="hero-label">LAST 24H</div><div class="hero-value" id="h-24h">--</div><div class="hero-sub" id="h-24h-sub"></div></div>
      <div class="hero-card" onclick="drillHero('bots')"><div class="hero-label">BOTS DETECTED</div><div class="hero-value" id="h-bots">--</div><div class="hero-sub" id="h-bots-sub"></div></div>
      <div class="hero-card" onclick="drillHero('botpct')"><div class="hero-label">BOT RATE</div><div class="hero-value" id="h-botpct">--</div><div class="hero-sub" id="h-botpct-sub"></div></div>
      <div class="hero-card" onclick="drillHero('fp')"><div class="hero-label">UNIQUE FP</div><div class="hero-value" id="h-fp">--</div><div class="hero-sub" id="h-fp-sub"></div></div>
      <div class="hero-card" onclick="drillHero('evasion')"><div class="hero-label">EVASION</div><div class="hero-value" id="h-evasion">--</div><div class="hero-sub" id="h-evasion-sub"></div></div>
    </div>

    <!-- Pipeline (simple) -->
    <div class="pipeline" id="a-pipeline" style="margin-bottom:24px;">
      <div class="pipe-node"><div class="pipe-node-label">RAW HITS</div><div class="pipe-node-value" id="a-pipe-raw">--</div></div>
      <div class="pipe-arrow"></div>
      <div class="pipe-node"><div class="pipe-node-label">ETL PARSE</div><div class="pipe-node-value" id="a-pipe-parsed">--</div></div>
      <div class="pipe-arrow"></div>
      <div class="pipe-node"><div class="pipe-node-label">167 SIGNALS</div><div class="pipe-node-value" style="color:var(--cyan); font-size:0.72rem;">PER HIT</div></div>
      <div class="pipe-arrow"></div>
      <div class="pipe-node"><div class="pipe-node-label">DASHBOARD</div><div class="pipe-node-value" style="color:var(--green);">LIVE</div></div>
    </div>

    <!-- Hourly + Risk -->
    <div class="panel-grid">
      <div class="panel">
        <div class="panel-title">HOURLY TRAFFIC</div>
        <div class="chart-container" id="hourly-chart"><div class="loading">LOADING</div></div>
      </div>
      <div class="panel">
        <div class="panel-title">RISK BREAKDOWN</div>
        <div class="risk-list" id="risk-list"><div class="loading">LOADING</div></div>
      </div>
    </div>

    <!-- Live Feed (full, 30 hits) + Signals -->
    <div class="panel-grid">
      <div class="panel">
        <div class="panel-title">LIVE FEED</div>
        <div style="overflow-x:auto;">
          <table class="feed-table">
            <thead><tr><th>TIME</th><th>IP</th><th>THREAT</th><th>SCORE</th><th>PLATFORM</th><th>BROWSER</th><th>RESOLUTION</th><th>FINGERPRINT</th><th>SIGNALS</th></tr></thead>
            <tbody id="a-feed-body"><tr><td colspan="9" class="loading">LOADING</td></tr></tbody>
          </table>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title">TOP BOT SIGNALS</div>
        <div class="signal-list" id="signal-list"><div class="loading">LOADING</div></div>
      </div>
    </div>

    <!-- Evasion + Behavior + Fingerprints -->
    <div class="panel-grid triple">
      <div class="panel">
        <div class="panel-title">EVASION COUNTERMEASURES</div>
        <div class="evasion-grid" id="evasion-grid"><div class="loading">LOADING</div></div>
      </div>
      <div class="panel">
        <div class="panel-title">BEHAVIORAL ANALYSIS</div>
        <div class="behavior-compare" id="behavior-compare"><div class="loading">LOADING</div></div>
      </div>
      <div class="panel">
        <div class="panel-title">FINGERPRINT CLUSTERS</div>
        <div class="fp-cluster-list" id="fp-clusters"><div class="loading">LOADING</div></div>
      </div>
    </div>

    <!-- Devices + ETL -->
    <div class="panel-grid half">
      <div class="panel">
        <div class="panel-title">DEVICE BREAKDOWN</div>
        <div id="device-breakdown"><div class="loading">LOADING</div></div>
      </div>
      <div class="panel">
        <div class="panel-title">ETL HEALTH</div>
        <div id="a-etl-details" style="font-size:0.82rem;"><div class="loading">LOADING</div></div>
      </div>
    </div>
  </div>
</div>

<!-- SHARED MODAL (persists across views) -->
<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal-panel">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <div class="modal-title" id="modal-title"></div>
    <div class="modal-body" id="modal-body"></div>
  </div>
</div>

<script>
// ============================================================================
// DATA LAYER
// ============================================================================
const API = {
  health:       () => fetchJson('/api/dash/health'),
  infra:        () => fetchJson('/api/dash/infra'),
  recent:       () => fetchJson('/api/dash/recent'),
  hourly:       (h=48) => fetchJson(`/api/dash/hourly?hours=${h}`),
  bots:         () => fetchJson('/api/dash/bots'),
  signals:      () => fetchJson('/api/dash/bot-signals'),
  devices:      () => fetchJson('/api/dash/devices'),
  evasion:      () => fetchJson('/api/dash/evasion'),
  behavior:     () => fetchJson('/api/dash/behavior'),
  fingerprints: () => fetchJson('/api/dash/fingerprints?limit=12'),
};

let lastData = {};

async function fetchJson(url) {
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error(`${res.status}`);
    return await res.json();
  } catch (e) {
    console.warn('Fetch failed:', url, e);
    return null;
  }
}

// ============================================================================
// GRID PULSE CANVAS — Light beams race along grid lines (persistent)
// ============================================================================
(function initGridPulse() {
  const canvas = document.getElementById('grid-canvas');
  const ctx = canvas.getContext('2d');
  let pulses = [];
  const GRID = 60;

  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  function spawnPulse() {
    if (pulses.length >= 4) return;
    const isH = Math.random() > 0.5;
    if (isH) {
      const y = Math.floor(Math.random() * (canvas.height / GRID)) * GRID;
      const goRight = Math.random() > 0.5;
      pulses.push({
        x: goRight ? -50 : canvas.width + 50,
        y: y,
        dx: goRight ? (2.5 + Math.random() * 2) : -(2.5 + Math.random() * 2),
        dy: 0, life: 1, len: 150 + Math.random() * 250,
        hue: Math.random() > 0.85 ? 140 : 188
      });
    } else {
      const x = Math.floor(Math.random() * (canvas.width / GRID)) * GRID;
      const goDown = Math.random() > 0.5;
      pulses.push({
        x: x,
        y: goDown ? -50 : canvas.height + 50,
        dx: 0,
        dy: goDown ? (2.5 + Math.random() * 2) : -(2.5 + Math.random() * 2),
        life: 1, len: 150 + Math.random() * 250,
        hue: Math.random() > 0.85 ? 140 : 188
      });
    }
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = pulses.length - 1; i >= 0; i--) {
      const p = pulses[i];
      const tailX = p.x - (p.dx ? p.dx / Math.abs(p.dx) * p.len : 0);
      const tailY = p.y - (p.dy ? p.dy / Math.abs(p.dy) * p.len : 0);

      const grad = ctx.createLinearGradient(tailX, tailY, p.x, p.y);
      grad.addColorStop(0, `hsla(${p.hue}, 100%, 50%, 0)`);
      grad.addColorStop(0.6, `hsla(${p.hue}, 100%, 50%, ${0.08 * p.life})`);
      grad.addColorStop(1, `hsla(${p.hue}, 100%, 50%, ${0.35 * p.life})`);

      ctx.beginPath();
      ctx.strokeStyle = grad;
      ctx.lineWidth = 1.5;
      ctx.moveTo(tailX, tailY);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();

      ctx.save();
      ctx.beginPath();
      ctx.fillStyle = `hsla(${p.hue}, 100%, 70%, ${0.8 * p.life})`;
      ctx.shadowColor = `hsl(${p.hue}, 100%, 50%)`;
      ctx.shadowBlur = 20;
      ctx.arc(p.x, p.y, 2.5, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();

      const nearGridX = Math.abs(p.x % GRID) < 5 || Math.abs(p.x % GRID - GRID) < 5;
      const nearGridY = Math.abs(p.y % GRID) < 5 || Math.abs(p.y % GRID - GRID) < 5;
      if (nearGridX && nearGridY) {
        ctx.save();
        ctx.beginPath();
        ctx.fillStyle = `hsla(${p.hue}, 100%, 60%, ${0.4 * p.life})`;
        ctx.shadowColor = `hsl(${p.hue}, 100%, 50%)`;
        ctx.shadowBlur = 30;
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      }

      p.x += p.dx;
      p.y += p.dy;
      const margin = p.len + 100;
      if (p.x > canvas.width + margin || p.x < -margin ||
          p.y > canvas.height + margin || p.y < -margin) {
        pulses.splice(i, 1);
      }
    }
    requestAnimationFrame(draw);
  }

  window.addEventListener('resize', resize);
  resize();
  draw();
  function scheduleSpawn() { spawnPulse(); setTimeout(scheduleSpawn, 2500 + Math.random() * 4000); }
  setTimeout(scheduleSpawn, 800);
  setTimeout(spawnPulse, 300);
})();

// ============================================================================
// MODAL SYSTEM (shared)
// ============================================================================
function openModal(title, bodyHtml) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').innerHTML = bodyHtml;
  document.getElementById('modal-overlay').classList.add('active');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('active');
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function di(label, value, cls) {
  return `<div class="detail-item"><div class="detail-label">${label}</div><div class="detail-value${cls ? ' ' + cls : ''}">${value}</div></div>`;
}

function sug(text) {
  return `<div class="suggestion"><div class="suggestion-title">TROUBLESHOOTING</div>${text}</div>`;
}

// ============================================================================
// VIEW SWITCHING (SPA navigation — canvas persists)
// ============================================================================
let currentView = 'ops';

function switchView(view) {
  if (view === currentView) return;
  closeModal();
  currentView = view;

  document.getElementById('view-ops').className = 'view-content' + (view === 'ops' ? ' active' : '');
  document.getElementById('view-analytics').className = 'view-content' + (view === 'analytics' ? ' active' : '');
  document.getElementById('nav-ops').className = 'nav-tab' + (view === 'ops' ? ' active' : '');
  document.getElementById('nav-analytics').className = 'nav-tab' + (view === 'analytics' ? ' active' : '');
  document.getElementById('logo-sub').textContent = view === 'ops' ? 'Operations Center' : 'Analytics & Intelligence';
  document.getElementById('etl-header-wrap').style.display = view === 'ops' ? '' : 'none';
  document.title = view === 'ops' ? 'SmartPiXL // TRON — Operations' : 'SmartPiXL // TRON — Analytics';

  history.pushState({ view }, '', view === 'ops' ? '/tron' : '/tron/analytics');
  window.scrollTo(0, 0);
  countdown = 0; // trigger immediate refresh
}

function applyView(view) {
  currentView = view;
  document.getElementById('view-ops').className = 'view-content' + (view === 'ops' ? ' active' : '');
  document.getElementById('view-analytics').className = 'view-content' + (view === 'analytics' ? ' active' : '');
  document.getElementById('nav-ops').className = 'nav-tab' + (view === 'ops' ? ' active' : '');
  document.getElementById('nav-analytics').className = 'nav-tab' + (view === 'analytics' ? ' active' : '');
  document.getElementById('logo-sub').textContent = view === 'ops' ? 'Operations Center' : 'Analytics & Intelligence';
  document.getElementById('etl-header-wrap').style.display = view === 'ops' ? '' : 'none';
  document.title = view === 'ops' ? 'SmartPiXL // TRON — Operations' : 'SmartPiXL // TRON — Analytics';
}

window.addEventListener('popstate', (e) => {
  const view = e.state?.view || (location.pathname.includes('analytics') ? 'analytics' : 'ops');
  applyView(view);
  countdown = 0;
});

// Initial view from URL
(function() {
  const init = location.pathname.includes('analytics') ? 'analytics' : 'ops';
  applyView(init);
  history.replaceState({ view: init }, '', location.pathname);
})();

// ============================================================================
// HELPERS (shared)
// ============================================================================
function num(n) { if (n == null) return '--'; return Number(n).toLocaleString(); }

function formatDuration(sec) {
  if (sec < 60) return sec + 's';
  if (sec < 3600) return Math.floor(sec/60) + 'm';
  if (sec < 86400) return Math.floor(sec/3600) + 'h ' + Math.floor((sec%3600)/60) + 'm';
  return Math.floor(sec/86400) + 'd';
}

function timeAgo(dt) {
  const d = new Date(dt);
  const sec = Math.floor((Date.now() - d.getTime()) / 1000);
  if (sec < 0) return 'just now';
  if (sec < 60) return sec + 's ago';
  if (sec < 3600) return Math.floor(sec/60) + 'm ago';
  return Math.floor(sec/3600) + 'h ago';
}

// ============================================================================
// ██████  OPERATIONS RENDERERS & DRILL-DOWNS
// ============================================================================

// ─── Drill-Down: Pipeline Nodes ───
function drillPipeline(stage) {
  const infra = lastData.infra;
  const health = lastData.health;
  if (!infra && !health) { openModal('NO DATA', '<div style="color:var(--text-dim)">Waiting for data...</div>'); return; }
  const df = infra?.dataFlow;
  const sql = infra?.sql;
  let html = '<div class="detail-grid">';

  if (stage === 'ingest') {
    html += di('Queue Depth', df?.queueDepth ?? '--', df?.queueDepth > 100 ? 'warn' : 'ok');
    html += di('Hits Last 5m', df?.hitsLast5Min ?? '--', df?.hitsLast5Min === 0 ? 'bad' : 'ok');
    html += di('Hits Last Hour', df?.hitsLastHour ?? '--', df?.hitsLastHour === 0 ? 'warn' : 'ok');
    html += di('Is Flowing', df?.isFlowing ? 'YES' : 'NO', df?.isFlowing ? 'ok' : 'bad');
    html += di('Last Insert', df?.secondsSinceLastInsert != null ? formatDuration(df.secondsSinceLastInsert) + ' ago' : '--');
    html += di('Write Service', infra?.app ? 'PID ' + infra.app.processId : '--', 'cyan');
    html += '</div>';
    html += sug('If the queue is backing up, check SQL Server connectivity and disk I/O. If hits are 0, verify that tracking requests are reaching the server (check IIS logs). The write queue should normally be near 0.');
    openModal('INGEST STAGE', html);
  }
  else if (stage === 'sql') {
    html += di('Connected', sql?.isConnected ? 'YES' : 'NO', sql?.isConnected ? 'ok' : 'bad');
    html += di('Response Time', sql?.responseMs != null ? sql.responseMs + 'ms' : '--', sql?.responseMs > 200 ? 'warn' : 'ok');
    html += di('Data Source', sql?.dataSource || '--');
    html += di('Database', sql?.database || '--');
    html += di('PiXL.Test Rows', num(sql?.testRows));
    html += di('PiXL.Parsed Rows', num(sql?.parsedRows));
    html += di('Watermark', num(sql?.watermark));
    html += di('Last ETL Run', sql?.lastEtlRun ? timeAgo(sql.lastEtlRun) : '--');
    html += '</div>';
    if (!sql?.isConnected) {
      html += sug('SQL Server is disconnected. Check that the SQL2025 instance is running:<br><code style="color:var(--cyan)">Get-Service MSSQL$SQL2025</code><br>Verify the connection string in appsettings.json points to localhost\\SQL2025.');
    } else {
      html += sug('SQL connection is healthy. PiXL.Test stores raw ingested hits. PiXL.Parsed contains ETL-processed rows with all 167+ signals materialized.');
    }
    openModal('SQL WRITE STAGE', html);
  }
  else if (stage === 'etl') {
    html += di('Watermark', num(sql?.watermark ?? health?.etL_Watermark));
    html += di('Total Processed', num(health?.etL_TotalProcessed));
    html += di('Parsed Rows', num(sql?.parsedRows ?? health?.totalHits));
    html += di('ETL Lag', df?.etlLag != null ? df.etlLag + ' rows' : '--', df?.etlLag > 50 ? 'warn' : 'ok');
    html += di('Last ETL Run', health?.etL_LastRunAt ? timeAgo(health.etL_LastRunAt) : '--');
    html += di('Synthetic Hits', num(health?.syntheticHits));
    html += '</div>';
    html += sug('ETL runs every 60 seconds via EtlBackgroundService, calling usp_ParseNewHits. If lag is high, run manually:<br><code style="color:var(--cyan)">EXEC usp_ParseNewHits</code><br>If watermark is ahead of max Test ID, reset with:<br><code style="color:var(--cyan)">UPDATE ETL_Watermark SET LastProcessedId = 0</code>');
    openModal('ETL PARSE STAGE', html);
  }
  else if (stage === 'dash') {
    html += di('Status', df?.isFlowing ? 'LIVE' : 'STALE', df?.isFlowing ? 'ok' : 'bad');
    html += di('ETL Lag', df?.etlLag != null ? df.etlLag + ' rows' : '--', df?.etlLag > 50 ? 'warn' : 'ok');
    html += di('Data Freshness', health?.secondsSinceLastHit != null ? formatDuration(health.secondsSinceLastHit) + ' ago' : '--');
    html += di('24h Hits', num(health?.hits_24h));
    html += di('Total Hits', num(health?.totalHits));
    html += di('Unique Fingerprints', num(health?.uniqueFP_24h));
    html += '</div>';
    html += sug('Dashboard reads from materialized views on PiXL.Parsed. If showing stale, ensure ETL is processing and that the views are querying PiXL.Parsed (not the old dbo schema).');
    openModal('DASHBOARD STAGE', html);
  }
}

// ─── Drill-Down: Status Chips ───
function drillStatus(type) {
  const infra = lastData.infra;
  const health = lastData.health;
  if (!infra && !health) return;
  let html = '<div class="detail-grid">';

  if (type === 'overall') {
    html += di('Status', infra?.overallStatus?.toUpperCase() || '--', infra?.overallStatus === 'healthy' ? 'ok' : infra?.overallStatus === 'critical' ? 'bad' : 'warn');
    html += di('Probe Time', (infra?.probeTimeMs || 0) + 'ms');
    const svcUp = (infra?.services || []).filter(s => s.isRunning).length;
    const svcTotal = (infra?.services || []).length;
    html += di('Services', `${svcUp}/${svcTotal} running`, svcUp === svcTotal ? 'ok' : 'bad');
    const webUp = (infra?.websites || []).filter(w => w.isHealthy).length;
    const webTotal = (infra?.websites || []).length;
    html += di('Endpoints', `${webUp}/${webTotal} healthy`, webUp === webTotal ? 'ok' : 'bad');
    html += di('SQL', infra?.sql?.isConnected ? 'Connected' : 'Disconnected', infra?.sql?.isConnected ? 'ok' : 'bad');
    html += di('Data Flow', infra?.dataFlow?.isFlowing ? 'Active' : 'Stopped', infra?.dataFlow?.isFlowing ? 'ok' : 'bad');
    html += '</div>';
    openModal('SYSTEM OVERVIEW', html);
  }
  else if (type === 'dataflow') {
    const df = infra?.dataFlow;
    html += di('Is Flowing', df?.isFlowing ? 'YES' : 'NO', df?.isFlowing ? 'ok' : 'bad');
    html += di('Hits Last 5m', df?.hitsLast5Min ?? '--');
    html += di('Hits Last Hour', df?.hitsLastHour ?? '--');
    html += di('Queue Depth', df?.queueDepth ?? '--');
    html += di('Max Test ID', num(df?.maxTestId));
    html += di('Since Last Insert', df?.secondsSinceLastInsert != null ? formatDuration(df.secondsSinceLastInsert) : '--');
    html += di('ETL Lag', df?.etlLag != null ? df.etlLag + ' rows' : '--');
    html += di('Last Insert UTC', df?.lastInsertUtc || '--');
    html += '</div>';
    openModal('DATA FLOW DETAIL', html);
  }
  else if (type === 'sql') {
    const s = infra?.sql;
    html += di('Connected', s?.isConnected ? 'YES' : 'NO', s?.isConnected ? 'ok' : 'bad');
    html += di('Instance', s?.dataSource || '--');
    html += di('Database', s?.database || '--');
    html += di('Response', s?.responseMs != null ? s.responseMs + 'ms' : '--');
    html += di('PiXL.Test', num(s?.testRows) + ' rows');
    html += di('PiXL.Parsed', num(s?.parsedRows) + ' rows');
    html += di('Watermark', num(s?.watermark));
    html += di('Last ETL', s?.lastEtlRun ? timeAgo(s.lastEtlRun) : '--');
    html += '</div>';
    if (s?.error) html += `<div class="full-text" style="color:var(--red)">${s.error}</div>`;
    openModal('SQL SERVER DETAIL', html);
  }
  else if (type === 'iis') {
    const sites = infra?.websites || [];
    html = '<div style="display:flex;flex-direction:column;gap:8px;">';
    sites.forEach(w => {
      const ok = w.isHealthy;
      html += `<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(0,243,255,0.03);border:1px solid ${ok ? 'rgba(0,255,136,0.15)' : 'rgba(255,45,85,0.2)'};border-radius:4px;">
        <div class="infra-dot ${ok ? 'up' : 'down'}"></div>
        <div style="flex:1;"><div style="font-weight:bold;">${w.name}</div><div style="font-size:0.75rem;color:var(--text-dim)">${w.url || ''}</div></div>
        <div style="color:${ok ? 'var(--green)' : 'var(--red)'}">${ok ? 'HTTP ' + w.statusCode : (w.error || 'HTTP ' + w.statusCode)}</div>
        <div style="color:var(--cyan-dim)">${w.responseMs}ms</div>
      </div>`;
    });
    html += '</div>';
    openModal('IIS ENDPOINTS', html);
  }
  else if (type === 'etl') {
    html += di('Watermark', num(health?.etL_Watermark));
    html += di('Total Processed', num(health?.etL_TotalProcessed));
    html += di('Parsed Rows', num(health?.totalHits));
    html += di('Last Run', health?.etL_LastRunAt ? timeAgo(health.etL_LastRunAt) : '--');
    html += di('Lag', infra?.dataFlow?.etlLag != null ? infra.dataFlow.etlLag + ' rows' : '--');
    html += di('Synthetic Hits', num(health?.syntheticHits));
    html += '</div>';
    openModal('ETL DETAIL', html);
  }
  else if (type === 'lasthit') {
    html += di('Time Since Last', health?.secondsSinceLastHit != null ? formatDuration(health.secondsSinceLastHit) : '--');
    html += di('24h Hits', num(health?.hits_24h));
    html += di('1h Hits', num(health?.hits_1h));
    html += di('7d Hits', num(health?.hits_7d));
    html += di('Bots 24h', num(health?.bots_24h));
    html += di('Bot Rate', health?.botPct_24h != null ? health.botPct_24h.toFixed(1) + '%' : '--');
    html += '</div>';
    openModal('TRAFFIC DETAIL', html);
  }
}

// ─── Drill-Down: Error Entry ───
function drillError(idx) {
  const errors = lastData.infra?.recentErrors?.errors;
  if (!errors || !errors[idx]) return;
  const e = errors[idx];
  let html = '<div class="detail-grid">';
  html += di('Source', e.source || 'Unknown');
  html += di('Count', e.count || 1);
  html += di('Last Seen', e.lastSeenUtc ? timeAgo(e.lastSeenUtc) : '--');
  html += di('Status', e.isStale ? 'Stale' : 'Active', e.isStale ? 'warn' : 'bad');
  html += '</div>';
  html += '<div class="full-text">' + (e.message || 'No message') + '</div>';
  openModal('ERROR DETAIL', html);
}

// ─── Drill-Down: Critical Issue ───
function drillIssue(idx) {
  const issues = lastData._issues;
  if (!issues || !issues[idx]) return;
  const issue = issues[idx];
  let html = '<div class="detail-grid">';
  html += di('Severity', issue.severity.toUpperCase(), issue.severity === 'critical' ? 'bad' : 'warn');
  html += di('Detected', issue.time ? timeAgo(issue.time) : 'Current');
  html += '</div>';
  html += '<div style="margin-top:16px;font-size:0.85rem;line-height:1.6;color:var(--text);">' + issue.detail + '</div>';
  const fixes = getFixSuggestion(issue);
  if (fixes) html += sug(fixes);
  openModal(issue.title, html);
}

function getFixSuggestion(issue) {
  const t = issue.title.toLowerCase();
  if (t.includes('sql') && t.includes('disconnect')) return 'Check SQL Server service:<br><code style="color:var(--cyan)">Get-Service MSSQL$SQL2025</code><br>If stopped, start it:<br><code style="color:var(--cyan)">Start-Service MSSQL$SQL2025</code>';
  if (t.includes('data not flowing')) return 'Check that the TrackingPixel process is running and that the IIS app pool identity has SQL permissions.<br><code style="color:var(--cyan)">Get-Process TrackingPixel</code>';
  if (t.includes('service down')) return 'Restart the service from PowerShell:<br><code style="color:var(--cyan)">Start-Service "ServiceName"</code>';
  if (t.includes('endpoint down') || t.includes('endpoint unhealthy')) return 'Check IIS application pool status:<br><code style="color:var(--cyan)">Get-WebAppPoolState "Smartpixl.info"</code><br>If stopped:<br><code style="color:var(--cyan)">Start-WebAppPool "Smartpixl.info"</code>';
  if (t.includes('error')) return 'Check the application log for details:<br><code style="color:var(--cyan)">Get-Content "C:\\inetpub\\Smartpixl.info\\Log\\*.log" -Tail 50</code>';
  if (t.includes('etl lag')) return 'Run the ETL manually:<br><code style="color:var(--cyan)">sqlcmd -S "localhost\\SQL2025" -d SmartPiXL -Q "EXEC usp_ParseNewHits"</code>';
  if (t.includes('no recent hit')) return 'Verify traffic is reaching the server. Send a test hit:<br><code style="color:var(--cyan)">Invoke-WebRequest "http://192.168.88.176/TEST/verify_SMART.GIF" -UseBasicParsing</code>';
  return null;
}

// ─── Critical Issues Engine ───
function buildIssues(health, infra) {
  const issues = [];
  if (infra) {
    if (infra.overallStatus === 'critical')
      issues.push({ severity: 'critical', title: 'Infrastructure Critical', detail: 'One or more core services are down. See infrastructure panel below.', time: infra.checkedAt });
    if (infra.dataFlow && !infra.dataFlow.isFlowing)
      issues.push({ severity: 'critical', title: 'Data Not Flowing', detail: `No data ingested in ${formatDuration(infra.dataFlow.secondsSinceLastInsert || 0)}. Queue: ${infra.dataFlow.queueDepth}. Check SQL connection and write service.`, time: infra.checkedAt });
    if (infra.sql && !infra.sql.isConnected)
      issues.push({ severity: 'critical', title: 'SQL Server Disconnected', detail: infra.sql.error || 'Cannot connect to SQL Server.', time: infra.checkedAt });
    if (infra.services) {
      infra.services.filter(s => !s.isRunning && s.critical).forEach(s => issues.push({ severity: 'critical', title: `Service Down: ${s.name}`, detail: s.error || 'Critical service not running.', time: infra.checkedAt }));
      infra.services.filter(s => !s.isRunning && !s.critical).forEach(s => issues.push({ severity: 'warning', title: `Service Stopped: ${s.name}`, detail: s.error || s.status, time: infra.checkedAt }));
    }
    if (infra.websites) {
      infra.websites.filter(w => !w.isHealthy && w.critical).forEach(w => issues.push({ severity: 'critical', title: `Endpoint Down: ${w.name}`, detail: w.error || `HTTP ${w.statusCode}`, time: infra.checkedAt }));
      infra.websites.filter(w => !w.isHealthy && !w.critical).forEach(w => issues.push({ severity: 'warning', title: `Endpoint Unhealthy: ${w.name}`, detail: w.error || `HTTP ${w.statusCode}`, time: infra.checkedAt }));
    }
    if (infra.recentErrors && infra.recentErrors.hasRecentErrors) {
      const re = infra.recentErrors;
      issues.push({ severity: 'warning', title: `${re.recentErrorCount} Active Error${re.recentErrorCount > 1 ? 's' : ''} in Log`, detail: `Most recent: ${re.errors[0]?.message?.substring(0,100) || 'Unknown'}`, time: re.lastErrorUtc });
    }
    if (infra.dataFlow && infra.dataFlow.etlLag > 100)
      issues.push({ severity: 'warning', title: 'ETL Lag High', detail: `Watermark is ${infra.dataFlow.etlLag} rows behind. Parsed data may be stale.`, time: infra.checkedAt });
    if (infra.dataFlow && infra.dataFlow.queueDepth > 100)
      issues.push({ severity: 'warning', title: 'Write Queue Backing Up', detail: `Queue depth: ${infra.dataFlow.queueDepth}. Writes may be slow.`, time: infra.checkedAt });
  }
  if (health) {
    const secSince = health.secondsSinceLastHit || 9999;
    if (secSince > 3600)
      issues.push({ severity: 'warning', title: 'No Recent Hits', detail: `Last hit ${formatDuration(secSince)} ago. Traffic may have stopped or ingestion is broken.`, time: null });
  }
  issues.sort((a, b) => {
    const sevOrder = { critical: 0, warning: 1 };
    return (sevOrder[a.severity] || 2) - (sevOrder[b.severity] || 2);
  });
  return issues;
}

let previousIssueCount = -1;

function renderCriticalZone(issues) {
  const zone = document.getElementById('critical-zone');
  lastData._issues = issues;

  if (!issues || issues.length === 0) {
    zone.innerHTML = `<div class="all-clear"><div class="all-clear-dot"></div><div class="all-clear-text">ALL SYSTEMS OPERATIONAL</div><div class="all-clear-sub">No issues detected</div></div>`;
    previousIssueCount = 0;
    return;
  }

  const critCount = issues.filter(i => i.severity === 'critical').length;
  const warnCount = issues.filter(i => i.severity === 'warning').length;
  const hasCritical = critCount > 0;
  const panelStyle = hasCritical ? '' : 'style="border-color:rgba(255,225,77,0.3);background:rgba(255,225,77,0.03);"';
  const iconClass = hasCritical ? '' : 'warning';
  const titleClass = hasCritical ? '' : 'warning';
  const titleText = hasCritical ? 'CRITICAL ISSUES DETECTED' : 'WARNINGS';
  const countText = `${critCount ? critCount + ' CRITICAL' : ''}${critCount && warnCount ? ' · ' : ''}${warnCount ? warnCount + ' WARNING' : ''}`;
  const shouldAnimate = previousIssueCount !== issues.length;
  zone.className = shouldAnimate ? 'slide-in' : '';

  zone.innerHTML = `
    <div class="critical-panel" ${panelStyle}>
      <div class="critical-header">
        <div class="critical-icon ${iconClass}"></div>
        <div class="critical-title ${titleClass}">${titleText}</div>
        <div class="critical-count">${countText}</div>
      </div>
      ${issues.map((issue, i) => `
        <div class="critical-issue ${issue.severity === 'warning' ? 'warning' : ''}" onclick="drillIssue(${i})">
          <div class="issue-severity ${issue.severity}">${issue.severity.toUpperCase()}</div>
          <div class="issue-body">
            <div class="issue-title">${issue.title}</div>
            <div class="issue-detail">${issue.detail}</div>
          </div>
          <div class="issue-time">${issue.time ? timeAgo(issue.time) : ''}</div>
        </div>
      `).join('')}
    </div>
  `;
  previousIssueCount = issues.length;
}

// ─── Ops: Status Strip ───
function renderStatusStrip(health, infra) {
  const strip = document.getElementById('status-strip');
  const chips = [];

  const os = infra?.overallStatus || 'unknown';
  const osDot = os === 'healthy' ? 'up' : os === 'degraded' ? 'warn' : os === 'critical' ? 'down' : 'idle';
  const osVal = os === 'healthy' ? 'ok' : os === 'degraded' ? 'warn' : os === 'critical' ? 'bad' : '';
  chips.push(`<div class="status-chip ${os}" onclick="drillStatus('overall')"><div class="chip-dot ${osDot}"></div><div class="chip-label">OVERALL</div><div class="chip-value ${osVal}">${os.toUpperCase()}</div></div>`);

  const df = infra?.dataFlow;
  const flowOk = df?.isFlowing;
  chips.push(`<div class="status-chip ${flowOk ? 'healthy' : df ? 'critical' : ''}" onclick="drillStatus('dataflow')"><div class="chip-dot ${flowOk ? 'up' : df ? 'down' : 'idle'}"></div><div class="chip-label">DATA FLOW</div><div class="chip-value ${flowOk ? 'ok' : df ? 'bad' : ''}">${flowOk ? `${df.hitsLast5Min}/5m` : df ? 'STOPPED' : '--'}</div></div>`);

  const sqlOk = infra?.sql?.isConnected;
  const sqlMs = infra?.sql?.responseMs;
  chips.push(`<div class="status-chip ${sqlOk ? 'healthy' : infra?.sql ? 'critical' : ''}" onclick="drillStatus('sql')"><div class="chip-dot ${sqlOk ? 'up' : infra?.sql ? 'down' : 'idle'}"></div><div class="chip-label">SQL</div><div class="chip-value ${sqlOk ? (sqlMs > 200 ? 'warn' : 'ok') : infra?.sql ? 'bad' : ''}">${sqlOk ? `${sqlMs}ms` : infra?.sql ? 'DOWN' : '--'}</div></div>`);

  const sites = infra?.websites || [];
  const iisDown = sites.filter(w => !w.isHealthy);
  chips.push(`<div class="status-chip ${iisDown.length ? 'critical' : sites.length ? 'healthy' : ''}" onclick="drillStatus('iis')"><div class="chip-dot ${sites.length === 0 ? 'idle' : iisDown.length === 0 ? 'up' : 'down'}"></div><div class="chip-label">IIS</div><div class="chip-value ${sites.length === 0 ? '' : iisDown.length === 0 ? 'ok' : 'bad'}">${sites.length === 0 ? '--' : iisDown.length === 0 ? `${sites.length}/${sites.length} UP` : `${iisDown.length} DOWN`}</div></div>`);

  const etlLag = df?.etlLag ?? null;
  chips.push(`<div class="status-chip ${etlLag > 50 ? 'degraded' : etlLag !== null ? 'healthy' : ''}" onclick="drillStatus('etl')"><div class="chip-dot ${etlLag === null ? 'idle' : etlLag > 50 ? 'warn' : 'up'}"></div><div class="chip-label">ETL</div><div class="chip-value ${etlLag === null ? '' : etlLag > 50 ? 'warn' : 'ok'}">${etlLag === null ? '--' : `LAG ${etlLag}`}</div></div>`);

  const secSince = health?.secondsSinceLastHit ?? null;
  const hitDot = secSince === null ? 'idle' : secSince < 300 ? 'up' : secSince < 3600 ? 'warn' : 'down';
  const hitVal = secSince === null ? '--' : secSince < 60 ? `${secSince}s ago` : formatDuration(secSince) + ' ago';
  const hitCls = secSince === null ? '' : secSince < 300 ? 'ok' : secSince < 3600 ? 'warn' : 'bad';
  const hitChipCls = secSince === null ? '' : secSince < 300 ? 'healthy' : secSince < 3600 ? 'degraded' : 'critical';
  chips.push(`<div class="status-chip ${hitChipCls}" onclick="drillStatus('lasthit')"><div class="chip-dot ${hitDot}"></div><div class="chip-label">LAST HIT</div><div class="chip-value ${hitCls}">${hitVal}</div></div>`);

  strip.innerHTML = chips.join('');
}

// ─── Ops: Pipeline ───
function renderPipeline(health, infra) {
  const df = infra?.dataFlow;
  const sql = infra?.sql;

  const queueDepth = df?.queueDepth ?? (infra?.app?.queueDepth ?? '--');
  document.getElementById('pipe-ingest-val').textContent = queueDepth;
  document.getElementById('pipe-ingest-sub').textContent = 'in queue';
  document.getElementById('pipe-ingest').className = 'pipe-node' + (queueDepth > 100 ? ' stale' : queueDepth !== '--' ? ' healthy' : '');

  const maxTestId = df?.maxTestId ?? (sql?.testRows ?? '--');
  document.getElementById('pipe-sql-val').textContent = typeof maxTestId === 'number' ? num(maxTestId) : maxTestId;
  document.getElementById('pipe-sql-sub').textContent = 'PiXL.Test';
  document.getElementById('pipe-sql').className = 'pipe-node' + (sql?.isConnected === false ? ' down' : sql?.isConnected ? ' healthy' : '');
  document.getElementById('pipe-arrow-1').className = 'pipe-arrow' + (sql?.isConnected === false ? ' dead' : '');

  const parsedRows = sql?.parsedRows ?? (health?.totalHits ?? '--');
  document.getElementById('pipe-etl-val').textContent = typeof parsedRows === 'number' ? num(parsedRows) : parsedRows;
  document.getElementById('pipe-etl-sub').textContent = 'PiXL.Parsed';
  const etlLag = df?.etlLag ?? null;
  document.getElementById('pipe-etl').className = 'pipe-node' + (etlLag > 50 ? ' stale' : etlLag !== null ? ' healthy' : '');
  document.getElementById('pipe-arrow-2').className = 'pipe-arrow' + (etlLag > 50 ? ' dead' : '');

  document.getElementById('pipe-dash-val').textContent = df?.isFlowing ? 'LIVE' : 'STALE';
  document.getElementById('pipe-dash-val').style.color = df?.isFlowing ? 'var(--green)' : 'var(--red)';
  document.getElementById('pipe-dash-sub').textContent = etlLag !== null ? `${etlLag} row lag` : '--';
  document.getElementById('pipe-dash').className = 'pipe-node' + (df?.isFlowing ? ' healthy' : df ? ' down' : '');
  document.getElementById('pipe-arrow-3').className = 'pipe-arrow' + (!df?.isFlowing ? ' dead' : '');

  if (df) {
    const staleStr = df.secondsSinceLastInsert > 0 ? formatDuration(df.secondsSinceLastInsert) + ' ago' : 'just now';
    document.getElementById('flow-5min').textContent = df.hitsLast5Min;
    document.getElementById('flow-5min').className = 'etl-val' + (df.hitsLast5Min === 0 ? ' bad' : '');
    document.getElementById('flow-1hr').textContent = df.hitsLastHour;
    document.getElementById('flow-1hr').className = 'etl-val' + (df.hitsLastHour === 0 ? ' warn' : '');
    document.getElementById('flow-last-insert').textContent = staleStr;
    document.getElementById('flow-last-insert').className = 'etl-val' + (df.secondsSinceLastInsert > 300 ? ' warn' : '');
    document.getElementById('flow-last-insert').style.fontSize = '0.8rem';
  }
}

// ─── Ops: Error Log ───
function renderErrorLog(infra) {
  const el = document.getElementById('error-log');
  const re = infra?.recentErrors;
  if (!re || !re.hasErrors) {
    el.innerHTML = '<div style="color:var(--green); font-size:0.82rem; padding: 16px; text-align:center; letter-spacing: 2px;">NO ERRORS TODAY</div>';
    return;
  }
  el.innerHTML = re.errors.map((e, i) => {
    const isStale = e.isStale;
    const countBadge = e.count > 1 ? `<span class="error-count">x${e.count}</span>` : '';
    const ageStr = e.lastSeenUtc ? timeAgo(e.lastSeenUtc) : '';
    return `<div class="error-entry ${isStale ? 'stale' : ''}" onclick="drillError(${i})">
      <div class="error-source">${e.source || '?'}</div>
      <div class="error-msg ${isStale ? 'stale' : ''}">${e.message?.substring(0, 150) || 'Unknown error'}${e.message?.length > 150 ? '...' : ''}</div>
      ${countBadge}
      <div class="error-age">${ageStr}</div>
    </div>`;
  }).join('');
}

// ─── Ops: ETL Health ───
function renderOpsETL(health) {
  const el = document.getElementById('etl-details');
  if (!health) { el.innerHTML = '<div style="color:var(--text-dim)">No health data</div>'; return; }
  el.innerHTML = `
    <div class="etl-grid">
      <div class="etl-stat"><div class="etl-val">${num(health.etL_TotalProcessed||0)}</div><div class="etl-lbl">ROWS PROCESSED</div></div>
      <div class="etl-stat"><div class="etl-val">${num(health.etL_Watermark||0)}</div><div class="etl-lbl">WATERMARK ID</div></div>
      <div class="etl-stat"><div class="etl-val">${num(health.totalHits)}</div><div class="etl-lbl">PARSED ROWS</div></div>
      <div class="etl-stat"><div class="etl-val">${num(health.syntheticHits||0)}</div><div class="etl-lbl">SYNTHETIC</div></div>
      <div class="etl-stat"><div class="etl-val" style="font-size:0.85rem;">${health.etL_LastRunAt ? timeAgo(health.etL_LastRunAt) : '--'}</div><div class="etl-lbl">LAST ETL RUN</div></div>
      <div class="etl-stat"><div class="etl-val">${num(health.hits_24h||0)}</div><div class="etl-lbl">HITS 24H</div></div>
    </div>
  `;
}

// ─── Ops: Infrastructure Detail ───
function renderInfraDetail(infra) {
  const el = document.getElementById('infra-detail');
  if (!infra) { el.innerHTML = '<div style="color:var(--text-dim)">Infrastructure probe unavailable</div>'; return; }
  let html = '<div class="infra-grid">';

  html += '<div>';
  html += '<div class="infra-group-title">Windows Services</div>';
  if (infra.services && infra.services.length) {
    infra.services.forEach(s => {
      const dotCls = s.isRunning ? 'up' : 'down';
      const detail = s.isRunning ? s.status : (s.error || s.status);
      const critTag = s.critical ? ' <span style="color:var(--red);font-size:0.65rem;font-weight:600;">CRITICAL</span>' : '';
      html += `<div class="infra-item"><div class="infra-dot ${dotCls}"></div><div class="infra-item-name">${s.name}${critTag}</div><div class="infra-item-detail">${detail}</div></div>`;
    });
  } else { html += '<div style="color:var(--text-dim);font-size:0.78rem;">No service data</div>'; }
  html += '</div>';

  html += '<div>';
  html += '<div class="infra-group-title">Website Endpoints</div>';
  if (infra.websites && infra.websites.length) {
    infra.websites.forEach(w => {
      const dotCls = w.isHealthy ? 'up' : 'down';
      const statusTxt = w.isHealthy ? `${w.statusCode} OK` : (w.error || `HTTP ${w.statusCode}`);
      const critTag = w.critical ? ' <span style="color:var(--red);font-size:0.65rem;font-weight:600;">CRITICAL</span>' : '';
      html += `<div class="infra-item"><div class="infra-dot ${dotCls}"></div><div class="infra-item-name">${w.name}${critTag}</div><div class="infra-item-detail">${statusTxt}</div><div class="infra-item-ms">${w.responseMs}ms</div></div>`;
    });
  } else { html += '<div style="color:var(--text-dim);font-size:0.78rem;">No website data</div>'; }
  html += '</div>';

  html += '<div>';
  html += '<div class="infra-group-title">SQL Server</div>';
  if (infra.sql) {
    const s = infra.sql;
    html += `<div class="infra-item"><div class="infra-dot ${s.isConnected ? 'up' : 'down'}"></div><div class="infra-item-name">${s.dataSource || 'SQL Server'} / ${s.database || '?'}</div><div class="infra-item-ms">${s.responseMs}ms</div></div>`;
    if (s.isConnected) {
      html += `<div style="font-size:0.78rem;color:var(--text-dim);padding:4px 0 0 18px;">PiXL.Test: ${num(s.testRows)} · PiXL.Parsed: ${num(s.parsedRows)} · Watermark: ${num(s.watermark)}</div>`;
      if (s.lastEtlRun) html += `<div style="font-size:0.72rem;color:var(--text-dim);padding:2px 0 0 18px;">Last ETL: ${timeAgo(s.lastEtlRun)}</div>`;
    } else {
      html += `<div style="font-size:0.78rem;color:var(--red);padding:4px 0 0 18px;">${s.error || 'Connection failed'}</div>`;
    }
  }
  html += '</div>';

  html += '<div>';
  html += '<div class="infra-group-title">App Runtime</div>';
  if (infra.app) {
    const a = infra.app;
    const uptimeSec = a.uptime ? (a.uptime.totalSeconds || (a.uptime.hours * 3600 + a.uptime.minutes * 60 + a.uptime.seconds) || 0) : 0;
    const uptimeStr = uptimeSec > 86400 ? Math.floor(uptimeSec/86400) + 'd ' + Math.floor((uptimeSec%86400)/3600) + 'h' :
                      uptimeSec > 3600 ? Math.floor(uptimeSec/3600) + 'h ' + Math.floor((uptimeSec%3600)/60) + 'm' :
                      Math.floor(uptimeSec/60) + 'm';
    html += `<div class="infra-app-grid">
      <div class="infra-app-stat"><div class="infra-app-val">${a.processId}</div><div class="infra-app-lbl">PID</div></div>
      <div class="infra-app-stat"><div class="infra-app-val">${uptimeStr}</div><div class="infra-app-lbl">UPTIME</div></div>
      <div class="infra-app-stat"><div class="infra-app-val">${a.workingSetMB}</div><div class="infra-app-lbl">MEM (MB)</div></div>
      <div class="infra-app-stat"><div class="infra-app-val">${a.threadCount}</div><div class="infra-app-lbl">THREADS</div></div>
      <div class="infra-app-stat"><div class="infra-app-val">${a.gcHeapMB}</div><div class="infra-app-lbl">GC HEAP</div></div>
      <div class="infra-app-stat"><div class="infra-app-val" style="${a.queueDepth > 100 ? 'color:var(--yellow)' : ''}">${a.queueDepth}</div><div class="infra-app-lbl">WRITE QUEUE</div></div>
    </div>`;
    html += `<div style="font-size:0.68rem;color:var(--text-dim);margin-top:6px;">${a.machineName} · .NET ${a.dotNetVersion}</div>`;
  }
  html += '</div>';
  html += '</div>';

  const checkedAt = infra.checkedAt ? new Date(infra.checkedAt).toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}) + ' UTC' : '--';
  html += `<div style="text-align:right;font-size:0.68rem;color:var(--text-dim);margin-top:12px;letter-spacing:1px;">Probed in ${infra.probeTimeMs || 0}ms · ${checkedAt}</div>`;
  el.innerHTML = html;
}

// ─── Ops: Compact Live Feed ───
function renderOpsFeed(data) {
  const tbody = document.getElementById('ops-feed-body');
  if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="7" style="color:var(--text-dim)">No recent hits</td></tr>'; return; }
  tbody.innerHTML = data.slice(0, 15).map((r, i) => {
    const t = r.threatLevel || 'OK';
    const badgeClass = t === 'HIGH' ? 'high' : t === 'MED' ? 'med' : t === 'LOW' ? 'low' : 'ok';
    const time = r.receivedAt ? new Date(r.receivedAt).toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}) : '--';
    return `<tr onclick="drillHit(${i})">
      <td>${time}</td>
      <td>${r.ipAddress || '--'}</td>
      <td><span class="badge ${badgeClass}">${t}</span></td>
      <td>${r.botScore ?? '--'}</td>
      <td>${r.platform || '--'}</td>
      <td>${r.browser || '--'}</td>
      <td style="color:var(--cyan)">${r.fP_Short || '--'}</td>
    </tr>`;
  }).join('');
}

// ─── Ops: Header Beacon ───
function updateOpsBeacon(health, infra) {
  const beacon = document.getElementById('beacon');
  const statusEl = document.getElementById('system-status');

  if (infra?.overallStatus === 'critical') {
    beacon.className = 'beacon-dot danger';
    statusEl.textContent = 'CRITICAL';
    statusEl.style.color = 'var(--red)';
  } else if (infra?.overallStatus === 'degraded') {
    beacon.className = 'beacon-dot warn';
    statusEl.textContent = 'DEGRADED';
    statusEl.style.color = 'var(--yellow)';
  } else if (health) {
    const secSince = health.secondsSinceLastHit || 9999;
    if (secSince < 300) {
      beacon.className = 'beacon-dot';
      statusEl.textContent = 'ONLINE';
      statusEl.style.color = '';
    } else if (secSince < 3600) {
      beacon.className = 'beacon-dot warn';
      statusEl.textContent = 'IDLE — ' + formatDuration(secSince);
      statusEl.style.color = 'var(--yellow)';
    } else {
      beacon.className = 'beacon-dot danger';
      statusEl.textContent = 'STALE — ' + formatDuration(secSince);
      statusEl.style.color = 'var(--red)';
    }
  }

  if (health) {
    document.getElementById('etl-status').textContent =
      health.etL_Watermark ? `#${num(health.etL_Watermark)}` : '--';
  }
}

// ============================================================================
// ██████  ANALYTICS RENDERERS & DRILL-DOWNS
// ============================================================================

// ─── Drill-Down: Hit (shared by both views) ───
function drillHit(idx) {
  const hits = lastData.recent;
  if (!hits || !hits[idx]) return;
  const r = hits[idx];
  let html = '<div class="detail-grid">';
  html += di('Time', r.receivedAt ? new Date(r.receivedAt).toISOString() : '--');
  html += di('IP Address', r.ipAddress || '--');
  html += di('Threat Level', r.threatLevel || 'OK', r.threatLevel === 'HIGH' ? 'bad' : r.threatLevel === 'MED' ? 'warn' : 'ok');
  html += di('Bot Score', r.botScore ?? '--', r.botScore >= 50 ? 'bad' : r.botScore >= 20 ? 'warn' : 'ok');
  html += di('Platform', r.platform || '--');
  html += di('Browser', r.browser || '--');
  html += di('Resolution', r.resolution || '--');
  html += di('Fingerprint', r.fP_Short || '--', 'cyan');
  html += '</div>';
  if (r.botSignalsList) {
    html += '<div style="margin-top:16px;"><div class="detail-label" style="margin-bottom:8px;">BOT SIGNALS</div>';
    html += '<div class="full-text">' + r.botSignalsList + '</div></div>';
  }
  openModal('HIT DETAIL', html);
}

// ─── Drill-Down: Hero Cards ───
function drillHero(type) {
  const h = lastData.health;
  if (!h) return;
  let html = '<div class="detail-grid">';
  if (type === 'total') {
    html += di('Total All Time', num(h.totalHits));
    html += di('Last 7 Days', num(h.hits_7d));
    html += di('Last 24 Hours', num(h.hits_24h));
    html += di('Last 1 Hour', num(h.hits_1h));
    html += di('ETL Processed', num(h.etL_TotalProcessed));
    html += di('Synthetic', num(h.syntheticHits));
  } else if (type === '24h') {
    html += di('24h Hits', num(h.hits_24h));
    html += di('1h Hits', num(h.hits_1h));
    html += di('7d Hits', num(h.hits_7d));
    html += di('Seconds Since Last', h.secondsSinceLastHit ?? '--');
    html += di('Bots 24h', num(h.bots_24h));
    html += di('Bot Rate 24h', (h.botPct_24h||0).toFixed(1) + '%');
  } else if (type === 'bots') {
    html += di('Bots 24h', num(h.bots_24h));
    html += di('High Risk Bots', num(h.highRiskBots_24h));
    html += di('Bot Rate', (h.botPct_24h||0).toFixed(1) + '%');
    html += di('Avg Bot Score', (h.avgBotScore_24h||0).toFixed(1));
    html += di('WebDriver Hits', num(h.webDriverHits));
    html += di('Evasion Detected', num(h.evasionDetected_AllTime));
  } else if (type === 'botpct') {
    html += di('Bot Rate 24h', (h.botPct_24h||0).toFixed(1) + '%', h.botPct_24h > 30 ? 'bad' : h.botPct_24h > 10 ? 'warn' : 'ok');
    html += di('Avg Bot Score', (h.avgBotScore_24h||0).toFixed(1));
    html += di('Total Bots 24h', num(h.bots_24h));
    html += di('Total Hits 24h', num(h.hits_24h));
  } else if (type === 'fp') {
    html += di('Unique FP 24h', num(h.uniqueFP_24h));
    html += di('Unique FP All Time', num(h.uniqueFP_AllTime));
    html += di('Total Hits', num(h.totalHits));
    html += di('Hits per FP (avg)', h.uniqueFP_AllTime ? (h.totalHits / h.uniqueFP_AllTime).toFixed(1) : '--');
  } else if (type === 'evasion') {
    html += di('Evasion Detected', num(h.evasionDetected_AllTime));
    html += di('WebDriver Hits', num(h.webDriverHits));
    html += di('Bot Rate', (h.botPct_24h||0).toFixed(1) + '%');
    html += di('High Risk Bots', num(h.highRiskBots_24h));
  }
  html += '</div>';
  openModal(type.toUpperCase() + ' DETAIL', html);
}

// ─── Drill-Down: Risk Row ───
function drillRisk(idx) {
  const bots = lastData.bots;
  if (!bots || !bots[idx]) return;
  const b = bots[idx];
  let html = '<div class="detail-grid">';
  html += di('Risk Bucket', b.riskBucket);
  html += di('Hit Count', num(b.hitCount));
  html += di('Unique Devices', num(b.uniqueDevices));
  html += di('Unique IPs', num(b.uniqueIPs));
  html += '</div>';
  openModal(b.riskBucket.toUpperCase(), html);
}

// ─── Drill-Down: Fingerprint ───
function drillFP(idx) {
  const fps = lastData.fingerprints;
  if (!fps || !fps[idx]) return;
  const fp = fps[idx];
  let html = '<div class="detail-grid">';
  html += di('Canvas Fingerprint', fp.canvasFingerprint || '--', 'cyan');
  html += di('Hit Count', num(fp.hitCount));
  html += di('Unique IPs', num(fp.uniqueIPs));
  html += di('Avg Bot Score', fp.avgBotScore != null ? fp.avgBotScore.toFixed(1) : '--', fp.avgBotScore >= 50 ? 'bad' : fp.avgBotScore >= 20 ? 'warn' : 'ok');
  html += di('Primary Platform', fp.primaryPlatform || '--');
  html += di('First Seen', fp.firstSeen ? new Date(fp.firstSeen).toLocaleDateString() : '--');
  html += '</div>';
  openModal('FINGERPRINT CLUSTER', html);
}

// ─── Drill-Down: Signal ───
function drillSignal(idx) {
  const signals = lastData.signals;
  if (!signals || !signals[idx]) return;
  const s = signals[idx];
  let html = '<div class="detail-grid">';
  html += di('Signal Name', s.signal, 'cyan');
  html += di('Times Triggered', num(s.timesTriggered));
  html += di('Unique Devices', num(s.uniqueDevices));
  html += '</div>';
  openModal('SIGNAL DETAIL', html);
}

// ─── Drill-Down: Hourly ───
function drillHour(idx) {
  const rows = lastData._hourlyRows;
  if (!rows || !rows[idx]) return;
  const r = rows[idx];
  let html = '<div class="detail-grid">';
  html += di('Hour', r.hourBucket);
  html += di('Total Hits', num(r.totalHits));
  html += di('Bot Hits', num(r.botHits), r.botHits > 0 ? 'bad' : 'ok');
  html += di('Human Hits', num((r.totalHits||0) - (r.botHits||0)), 'ok');
  html += '</div>';
  openModal('HOURLY DETAIL', html);
}

// ─── Analytics: Hero ───
function renderAnalyticsHero(h) {
  if (!h) return;
  const set = (id, val, sub) => {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
    const subEl = document.getElementById(id + '-sub');
    if (subEl && sub) subEl.textContent = sub;
  };
  set('h-total', num(h.totalHits), `${num(h.hits_7d)} last 7d`);
  set('h-24h', num(h.hits_24h), `${num(h.hits_1h)} last hour`);
  set('h-bots', num(h.bots_24h), `${num(h.highRiskBots_24h)} high risk`);

  const pct = h.botPct_24h || 0;
  const pctEl = document.getElementById('h-botpct');
  pctEl.textContent = pct.toFixed(1) + '%';
  pctEl.className = 'hero-value' + (pct > 30 ? ' danger' : pct > 10 ? ' warn' : ' good');
  document.getElementById('h-botpct-sub').textContent = `avg score ${(h.avgBotScore_24h||0).toFixed(1)}`;

  set('h-fp', num(h.uniqueFP_24h), `${num(h.uniqueFP_AllTime)} all time`);

  const evEl = document.getElementById('h-evasion');
  evEl.textContent = num(h.evasionDetected_AllTime);
  evEl.className = 'hero-value' + (h.evasionDetected_AllTime > 0 ? ' warn' : ' good');
  document.getElementById('h-evasion-sub').textContent = `${num(h.webDriverHits)} webdriver`;

  document.getElementById('a-pipe-raw').textContent = num(h.etL_TotalProcessed || h.totalHits);
  document.getElementById('a-pipe-parsed').textContent = num(h.totalHits);
}

// ─── Analytics: Beacon ───
function updateAnalyticsBeacon(h) {
  if (!h) return;
  const beacon = document.getElementById('beacon');
  const statusEl = document.getElementById('system-status');
  const secSince = h.secondsSinceLastHit || 9999;
  if (secSince < 300) {
    beacon.className = 'beacon-dot';
    statusEl.textContent = 'SYSTEM ONLINE';
    statusEl.style.color = '';
  } else if (secSince < 3600) {
    beacon.className = 'beacon-dot warn';
    statusEl.textContent = 'IDLE — ' + formatDuration(secSince);
    statusEl.style.color = 'var(--yellow)';
  } else {
    beacon.className = 'beacon-dot danger';
    statusEl.textContent = 'STALE — ' + formatDuration(secSince);
    statusEl.style.color = 'var(--red)';
  }
}

// ─── Analytics: ETL Details ───
function renderAnalyticsETL(h) {
  const el = document.getElementById('a-etl-details');
  if (!h) return;
  el.innerHTML = `
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 12px;">
      <div class="evasion-card"><div class="evasion-val">${num(h.etL_TotalProcessed||0)}</div><div class="evasion-lbl">ROWS PROCESSED</div></div>
      <div class="evasion-card"><div class="evasion-val">${num(h.etL_Watermark||0)}</div><div class="evasion-lbl">WATERMARK ID</div></div>
      <div class="evasion-card"><div class="evasion-val">${num(h.totalHits)}</div><div class="evasion-lbl">PARSED ROWS</div></div>
      <div class="evasion-card"><div class="evasion-val">${num(h.syntheticHits||0)}</div><div class="evasion-lbl">SYNTHETIC</div></div>
      <div class="evasion-card" style="grid-column:span 2;">
        <div class="evasion-val" style="font-size:0.9rem;">${h.etL_LastRunAt ? timeAgo(h.etL_LastRunAt) : '--'}</div>
        <div class="evasion-lbl">LAST ETL RUN</div>
      </div>
    </div>
  `;
}

// ─── Analytics: Hourly Chart ───
function renderHourlyChart(data) {
  const container = document.getElementById('hourly-chart');
  if (!data || !data.length) { container.innerHTML = '<div class="loading">NO DATA</div>'; return; }
  const rows = [...data].reverse().slice(-48);
  const maxHits = Math.max(...rows.map(r => r.totalHits || 1));

  container.innerHTML = rows.map((r, i) => {
    const total = r.totalHits || 0;
    const bots = r.botHits || 0;
    const humans = total - bots;
    const humanH = Math.max(1, (humans / maxHits) * 180);
    const botH = Math.max(0, (bots / maxHits) * 180);
    const hour = new Date(r.hourBucket).getUTCHours();
    const label = hour === 0 ? new Date(r.hourBucket).toLocaleDateString('en',{month:'short',day:'numeric',timeZone:'UTC'}) : `${hour}h`;
    return `<div class="chart-bar-group" title="${total} hits (${bots} bots) at ${r.hourBucket}" onclick="drillHour(${i})">
      <div class="chart-bar bot" style="height:${botH}px"></div>
      <div class="chart-bar human" style="height:${humanH}px"></div>
      ${hour % 6 === 0 ? `<div class="chart-label">${label}</div>` : ''}
    </div>`;
  }).join('');
  lastData._hourlyRows = rows;
}

// ─── Analytics: Risk List ───
function renderRiskList(data) {
  const el = document.getElementById('risk-list');
  if (!data || !data.length) { el.innerHTML = '<div style="color:var(--text-dim);font-size:0.78rem;">No data</div>'; return; }
  const indicatorClass = b => {
    if (b.riskBucket === 'High Risk') return 'high';
    if (b.riskBucket === 'Medium Risk') return 'medium';
    if (b.riskBucket === 'Low Risk') return 'low';
    return 'ok';
  };
  el.innerHTML = data.map((b, i) => `
    <div class="risk-row" onclick="drillRisk(${i})">
      <div class="risk-indicator ${indicatorClass(b)}"></div>
      <div class="risk-info">
        <div class="risk-label">${b.riskBucket}</div>
        <div class="risk-meta">${num(b.uniqueDevices)} devices · ${num(b.uniqueIPs)} IPs</div>
      </div>
      <div class="risk-count">${num(b.hitCount)}</div>
    </div>
  `).join('');
}

// ─── Analytics: Live Feed (full, 30 hits) ───
function renderAnalyticsFeed(data) {
  const tbody = document.getElementById('a-feed-body');
  if (!data || !data.length) { tbody.innerHTML = '<tr><td colspan="9" style="color:var(--text-dim)">No recent hits</td></tr>'; return; }
  tbody.innerHTML = data.slice(0, 30).map((r, i) => {
    const t = r.threatLevel || 'OK';
    const badgeClass = t === 'HIGH' ? 'high' : t === 'MED' ? 'med' : t === 'LOW' ? 'low' : 'ok';
    const time = r.receivedAt ? new Date(r.receivedAt).toLocaleTimeString('en',{hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}) : '--';
    return `<tr onclick="drillHit(${i})">
      <td>${time}</td>
      <td>${r.ipAddress || '--'}</td>
      <td><span class="badge ${badgeClass}">${t}</span></td>
      <td>${r.botScore ?? '--'}</td>
      <td>${r.platform || '--'}</td>
      <td>${r.browser || '--'}</td>
      <td>${r.resolution || '--'}</td>
      <td style="color:var(--cyan)">${r.fP_Short || '--'}</td>
      <td style="max-width:200px;color:var(--text-dim)">${r.botSignalsList || ''}</td>
    </tr>`;
  }).join('');
}

// ─── Analytics: Signals ───
function renderSignals(data) {
  const el = document.getElementById('signal-list');
  if (!data || !data.length) { el.innerHTML = '<div style="color:var(--text-dim)">No signals</div>'; return; }
  const maxCount = Math.max(...data.map(s => s.timesTriggered || 1));
  el.innerHTML = data.slice(0, 12).map((s, i) => {
    const pct = ((s.timesTriggered || 0) / maxCount * 100).toFixed(0);
    return `<div class="signal-row" onclick="drillSignal(${i})">
      <div class="signal-name" title="${s.signal}">${s.signal}</div>
      <div class="signal-bar-track"><div class="signal-bar-fill" style="width:${pct}%"></div></div>
      <div class="signal-count">${num(s.timesTriggered)}</div>
    </div>`;
  }).join('');
}

// ─── Analytics: Evasion ───
function renderEvasion(data) {
  const el = document.getElementById('evasion-grid');
  if (!data) { el.innerHTML = '<div>No data</div>'; return; }
  const items = [
    ['CANVAS', data.canvasEvasion], ['WEBGL', data.webGLEvasion],
    ['AUDIO NOISE', data.audioNoise], ['FONT SPOOF', data.fontSpoof],
    ['STEALTH', data.stealthDetected], ['EVASION TOOLS', data.evasionToolsFound],
    ['PROXY BLOCK', data.proxyBlocked], ['EVASION V2', data.evasionV2Signals],
    ['DNT ENABLED', data.dnT_Enabled],
  ];
  el.innerHTML = items.map(([label, val]) => {
    const v = val || 0;
    return `<div class="evasion-card"><div class="evasion-val ${v > 0 ? 'alert' : ''}">${num(v)}</div><div class="evasion-lbl">${label}</div></div>`;
  }).join('');
}

// ─── Analytics: Behavior ───
function renderBehavior(data) {
  const el = document.getElementById('behavior-compare');
  if (!data || !data.length) { el.innerHTML = '<div>No data</div>'; return; }
  const human = data.find(d => d.classification && d.classification.includes('<50'));
  const bot = data.find(d => d.classification && d.classification.includes('50'));
  const stat = (label, hv) => `<div class="behavior-stat"><span>${label}</span><span class="val">${hv??'--'}</span></div>`;
  const col = (title, cls, d) => `
    <div class="behavior-col">
      <div class="behavior-col-title ${cls}">${title}</div>
      ${stat('Hits', num(d?.hitCount))}
      ${stat('Avg Mouse Moves', (d?.avgMouseMoves||0).toFixed(0))}
      ${stat('Avg Entropy', (d?.avgMouseEntropy||0).toFixed(0))}
      ${stat('No Mouse', num(d?.noMouseHits))}
      ${stat('Zero Entropy', num(d?.zeroEntropyHits))}
      ${stat('Scrolled', num(d?.scrolledHits))}
      ${stat('Contradictions', num(d?.scrollContradictions))}
      ${stat('Flagged', num(d?.flaggedHits))}
    </div>
  `;
  el.innerHTML = col('HUMAN', 'human', human) + col('BOT', 'bot', bot);
}

// ─── Analytics: Fingerprints ───
function renderFingerprints(data) {
  const el = document.getElementById('fp-clusters');
  if (!data || !data.length) { el.innerHTML = '<div style="color:var(--text-dim)">No clusters</div>'; return; }
  el.innerHTML = data.slice(0, 10).map((fp, i) => {
    const hash = (fp.canvasFingerprint || '--').substring(0, 12);
    const score = fp.avgBotScore != null ? fp.avgBotScore.toFixed(0) : '--';
    const scoreColor = score >= 50 ? 'var(--red)' : score >= 20 ? 'var(--yellow)' : 'var(--green)';
    return `<div class="fp-row" onclick="drillFP(${i})">
      <div class="fp-hash">${hash}</div>
      <div class="fp-meta">${num(fp.uniqueIPs)} IPs · ${fp.primaryPlatform||'?'} · <span style="color:${scoreColor}">score ${score}</span></div>
      <div class="fp-hits">${num(fp.hitCount)}</div>
    </div>`;
  }).join('');
}

// ─── Analytics: Devices ───
function renderDevices(data) {
  const el = document.getElementById('device-breakdown');
  if (!data || !data.length) { el.innerHTML = '<div style="color:var(--text-dim)">No data</div>'; return; }
  const byPlatform = {};
  data.forEach(d => {
    const p = d.platform || 'Unknown';
    if (!byPlatform[p]) byPlatform[p] = { hits: 0, devices: 0, browsers: new Set() };
    byPlatform[p].hits += d.hitCount || 0;
    byPlatform[p].devices += d.uniqueDevices || 0;
    if (d.browser) byPlatform[p].browsers.add(d.browser);
  });
  const maxHits = Math.max(...Object.values(byPlatform).map(v => v.hits || 1));
  el.innerHTML = '<div class="signal-list">' + Object.entries(byPlatform)
    .sort((a, b) => b[1].hits - a[1].hits)
    .slice(0, 10)
    .map(([platform, info]) => {
      const pct = (info.hits / maxHits * 100).toFixed(0);
      return `<div class="signal-row">
        <div class="signal-name">${platform}</div>
        <div class="signal-bar-track"><div class="signal-bar-fill" style="width:${pct}%"></div></div>
        <div class="signal-count">${num(info.hits)}</div>
      </div>`;
    }).join('') + '</div>';
}

// ============================================================================
// REFRESH LOOP — Only active view fetches & renders
// ============================================================================
const REFRESH_INTERVAL = 10;
let countdown = REFRESH_INTERVAL;

async function refreshOps() {
  const [health, infra, recent] = await Promise.all([
    API.health(), API.infra(), API.recent()
  ]);
  lastData.health = health;
  lastData.infra = infra;
  lastData.recent = recent;

  const issues = buildIssues(health, infra);
  renderCriticalZone(issues);
  renderStatusStrip(health, infra);
  renderPipeline(health, infra);
  renderErrorLog(infra);
  renderOpsETL(health);
  renderInfraDetail(infra);
  renderOpsFeed(recent);
  updateOpsBeacon(health, infra);
}

async function refreshAnalytics() {
  const [health, hourly, bots, signals, evasion, behavior, recent, fingerprints, devices] =
    await Promise.all([
      API.health(), API.hourly(48), API.bots(), API.signals(),
      API.evasion(), API.behavior(), API.recent(), API.fingerprints(), API.devices()
    ]);

  lastData.health = health;
  lastData.hourly = hourly;
  lastData.bots = bots;
  lastData.signals = signals;
  lastData.evasion = evasion;
  lastData.behavior = behavior;
  lastData.recent = recent;
  lastData.fingerprints = fingerprints;
  lastData.devices = devices;

  renderAnalyticsHero(health);
  renderHourlyChart(hourly);
  renderRiskList(bots);
  renderSignals(signals);
  renderEvasion(evasion);
  renderBehavior(behavior);
  renderAnalyticsFeed(recent);
  renderFingerprints(fingerprints);
  renderDevices(devices);
  renderAnalyticsETL(health);
  updateAnalyticsBeacon(health);
}

async function refreshAll() {
  if (currentView === 'ops') await refreshOps();
  else await refreshAnalytics();
  countdown = REFRESH_INTERVAL;
}

setInterval(() => {
  document.getElementById('utc-clock').textContent = new Date().toISOString().substring(11, 19);
  countdown--;
  document.getElementById('countdown').textContent = Math.max(0, countdown);
  if (countdown <= 0) refreshAll();
}, 1000);

refreshAll();
</script>
</body>
</html>
