<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPiXL &mdash; Atlas</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <style>
        /* ================================================================
           DESIGN SYSTEM
           ================================================================ */
        :root {
            --bg-base: #060a13;
            --bg-surface: #0c1221;
            --bg-card: #111a2e;
            --bg-card-hover: #162040;
            --bg-elevated: #1a2540;
            --bg-panel: #0a1020;

            --text-primary: #edf2f7;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --text-dim: #475569;

            --accent-blue: #3b82f6;
            --accent-blue-light: #60a5fa;
            --accent-purple: #8b5cf6;
            --accent-green: #10b981;
            --accent-amber: #f59e0b;
            --accent-red: #ef4444;

            --gradient-brand: linear-gradient(135deg, #3b82f6, #8b5cf6);
            --gradient-text: linear-gradient(135deg, #60a5fa, #a78bfa);

            --border: rgba(255,255,255,0.06);
            --border-light: rgba(255,255,255,0.1);
            --border-active: rgba(59,130,246,0.4);

            --status-live: #10b981;
            --status-complete: #3b82f6;
            --status-inprogress: #f59e0b;
            --status-planned: #64748b;

            --radius: 16px;
            --radius-sm: 10px;
            --radius-xs: 6px;
            --ease: cubic-bezier(0.4, 0, 0.2, 1);
            --font-body: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            font-family: var(--font-body);
            background: var(--bg-base);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        /* ================================================================
           TYPOGRAPHY
           ================================================================ */
        h1 { font-size: clamp(2.5rem, 5vw, 4rem); font-weight: 900; letter-spacing: -0.04em; line-height: 1.05; }
        h2 { font-size: clamp(1.5rem, 3vw, 2.25rem); font-weight: 800; letter-spacing: -0.03em; line-height: 1.15; }
        h3 { font-size: 1.15rem; font-weight: 700; letter-spacing: -0.02em; }
        p  { color: var(--text-secondary); }

        a { color: var(--accent-blue-light); text-decoration: none; }
        a:hover { text-decoration: underline; }

        code, pre { font-family: var(--font-mono); font-size: 0.85rem; }
        code {
            background: rgba(59,130,246,0.1);
            color: #93c5fd;
            padding: 0.15em 0.4em;
            border-radius: 4px;
        }
        pre {
            background: #080d18;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem 1.25rem;
            overflow-x: auto;
            line-height: 1.6;
        }
        pre code { background: none; padding: 0; color: var(--text-primary); }

        /* ================================================================
           LAYOUT
           ================================================================ */
        .container    { max-width: 1200px; margin: 0 auto; padding: 0 2rem; }
        .container-xl { max-width: 1440px; margin: 0 auto; padding: 0 2rem; }

        /* ================================================================
           STICKY NAV
           ================================================================ */
        .nav {
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 1000;
            padding: 0 2rem;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(6,10,19,0.85);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            transform: translateY(-100%);
            pointer-events: none;
            transition: transform 0.35s var(--ease);
        }
        .nav.visible { transform: translateY(0); pointer-events: auto; }

        .nav-brand {
            font-weight: 800;
            font-size: 1rem;
            letter-spacing: -0.02em;
            background: var(--gradient-text);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .nav-links { display: flex; gap: 2rem; }
        .nav-links a {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 500;
            transition: color 0.3s var(--ease);
        }
        .nav-links a:hover { color: var(--text-primary); text-decoration: none; }

        /* ================================================================
           HERO
           ================================================================ */
        .hero {
            position: relative;
            min-height: 520px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5rem 2rem 4rem;
            overflow: hidden;
        }

        /* Animated gradient mesh */
        .hero-glow-1, .hero-glow-2, .hero-glow-3 {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            pointer-events: none;
        }
        .hero-glow-1 {
            width: 700px; height: 700px;
            background: radial-gradient(circle, rgba(59,130,246,0.15), transparent 70%);
            top: -30%; left: -15%;
            animation: glow1 18s ease-in-out infinite alternate;
        }
        .hero-glow-2 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(139,92,246,0.12), transparent 70%);
            bottom: -25%; right: -10%;
            animation: glow2 22s ease-in-out infinite alternate;
        }
        .hero-glow-3 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(16,185,129,0.08), transparent 70%);
            top: 20%; left: 55%;
            animation: glow3 20s ease-in-out infinite alternate;
        }
        @keyframes glow1 { 0% { transform: translate(0,0); } 100% { transform: translate(60px,40px); } }
        @keyframes glow2 { 0% { transform: translate(0,0); } 100% { transform: translate(-50px,-30px); } }
        @keyframes glow3 { 0% { transform: translate(0,0); } 100% { transform: translate(40px,-50px); } }

        /* Subtle dot grid */
        .hero-grid {
            position: absolute;
            inset: 0;
            background-image: radial-gradient(rgba(255,255,255,0.035) 1px, transparent 1px);
            background-size: 32px 32px;
            pointer-events: none;
        }

        .hero-content {
            position: relative;
            z-index: 1;
            text-align: center;
            max-width: 800px;
        }
        .hero h1 {
            margin-bottom: 1rem;
            background: var(--gradient-text);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .hero-subtitle {
            font-size: clamp(1rem, 1.5vw, 1.2rem);
            color: var(--text-secondary);
            max-width: 580px;
            margin: 0 auto 3rem;
            line-height: 1.7;
        }

        /* Hero Metrics */
        .hero-metrics {
            display: flex;
            justify-content: center;
            gap: 1.25rem;
            flex-wrap: wrap;
        }
        .hero-metric-card {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem 2rem;
            min-width: 160px;
            text-align: center;
            transition: border-color 0.3s var(--ease), background 0.3s var(--ease);
        }
        .hero-metric-card:hover {
            border-color: var(--border-light);
            background: rgba(255,255,255,0.05);
        }
        .hero-metric-value {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.03em;
            background: var(--gradient-text);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .hero-metric-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-top: 0.35rem;
        }

        /* ================================================================
           SECTION LABEL
           ================================================================ */
        .section-label {
            text-align: center;
            padding: 3.5rem 0 2rem;
        }
        .section-label h2 { margin-bottom: 0.5rem; }
        .section-label p {
            max-width: 520px;
            margin: 0 auto;
            font-size: 0.95rem;
        }

        /* ================================================================
           FEATURE GRID
           ================================================================ */
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem;
            padding-bottom: 2rem;
        }

        /* Feature Card */
        .feature-card {
            position: relative;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.3s var(--ease);
            display: flex;
            flex-direction: column;
        }
        .feature-card::before {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: var(--radius);
            background: var(--gradient-brand);
            opacity: 0;
            z-index: -1;
            transition: opacity 0.3s var(--ease);
        }
        .feature-card:hover {
            border-color: var(--border-light);
            background: var(--bg-card-hover);
            transform: translateY(-2px);
        }
        .feature-card:hover::before { opacity: 0.15; }
        .feature-card.active {
            border-color: var(--border-active);
            background: var(--bg-card-hover);
        }
        .feature-card.active::before { opacity: 0.25; }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .card-icon {
            width: 40px; height: 40px;
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(139,92,246,0.12));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-blue);
        }
        .card-icon svg { width: 20px; height: 20px; }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.65rem;
            color: var(--text-primary);
        }
        .card-pitch {
            font-size: 0.875rem;
            color: var(--text-secondary);
            line-height: 1.65;
            flex: 1;
        }
        .card-pitch p { font-size: inherit; max-width: none; }

        .card-metrics {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .card-metric {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .card-metric strong {
            color: var(--accent-blue-light);
            font-weight: 700;
        }

        .card-explore {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            margin-top: 1.25rem;
            padding: 0;
            background: none;
            border: none;
            color: var(--accent-blue);
            font-size: 0.8rem;
            font-weight: 600;
            font-family: var(--font-body);
            cursor: pointer;
            transition: gap 0.3s var(--ease), color 0.3s var(--ease);
        }
        .card-explore:hover { gap: 0.65rem; color: var(--accent-blue-light); }
        .card-explore svg { width: 14px; height: 14px; }

        /* ================================================================
           DETAIL PANEL
           ================================================================ */
        .detail-panel {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.5s var(--ease);
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
        }
        .detail-panel.open { grid-template-rows: 1fr; }

        .detail-panel-inner {
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.15s ease;
        }
        .detail-panel.open .detail-panel-inner {
            opacity: 1;
            transition: opacity 0.3s ease 0.15s;
        }

        .detail-panel-content { padding: 2.5rem 0; }

        .detail-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        .detail-title-group {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .detail-icon {
            width: 48px; height: 48px;
            border-radius: 12px;
            background: var(--gradient-brand);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .detail-icon svg { width: 24px; height: 24px; }
        .detail-title { font-size: 1.5rem; font-weight: 800; }

        .detail-close {
            width: 36px; height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s var(--ease);
        }
        .detail-close:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
        .detail-close svg { width: 18px; height: 18px; }

        .detail-section-metrics {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .detail-metric {
            display: flex;
            align-items: baseline;
            gap: 0.5rem;
        }
        .detail-metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent-blue-light);
        }
        .detail-metric-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Mermaid diagram in detail */
        .detail-diagram {
            background: #080d18;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            overflow-x: auto;
        }
        .detail-diagram:empty { display: none; }

        /* ================================================================
           TIER CONTENT STYLING
           ================================================================ */
        .tier-html {
            color: var(--text-secondary);
            line-height: 1.8;
            font-size: 0.925rem;
        }
        .tier-html p { margin-bottom: 1rem; max-width: none; font-size: inherit; }
        .tier-html ul, .tier-html ol { margin: 0.75rem 0 1rem 1.5rem; }
        .tier-html li { margin-bottom: 0.4rem; }
        .tier-html strong { color: var(--text-primary); font-weight: 600; }
        .tier-html h4 { margin: 1.5rem 0 0.5rem; color: var(--text-primary); font-size: 1.05rem; }

        .tier-html table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.85rem;
        }
        .tier-html th {
            text-align: left;
            padding: 0.65rem 0.85rem;
            background: rgba(59,130,246,0.08);
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
            font-weight: 600;
        }
        .tier-html td {
            padding: 0.55rem 0.85rem;
            border-bottom: 1px solid var(--border);
        }

        /* Mermaid diagrams embedded in tier HTML */
        .tier-html pre.mermaid {
            background: #080d18;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1.5rem;
            text-align: center;
        }

        /* ================================================================
           TIER EXPANDERS
           ================================================================ */
        .tier-expander {
            margin-top: 2rem;
            border-top: 1px solid var(--border);
            padding-top: 0.25rem;
        }

        .tier-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.25rem;
            margin-top: 0.75rem;
            background: rgba(59,130,246,0.06);
            border: 1px solid rgba(59,130,246,0.15);
            border-radius: var(--radius-xs);
            color: var(--accent-blue);
            font-size: 0.85rem;
            font-weight: 600;
            font-family: var(--font-body);
            cursor: pointer;
            transition: all 0.3s var(--ease);
            user-select: none;
        }
        .tier-toggle:hover {
            background: rgba(59,130,246,0.12);
            border-color: rgba(59,130,246,0.3);
        }
        .tier-toggle.expanded { background: rgba(59,130,246,0.12); }
        .tier-toggle svg {
            width: 16px; height: 16px;
            transition: transform 0.3s var(--ease);
        }
        .tier-toggle.expanded svg { transform: rotate(180deg); }

        .tier-expand-body {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.4s var(--ease);
        }
        .tier-expand-body.open { grid-template-rows: 1fr; }
        .tier-expand-inner { overflow: hidden; }
        .tier-expand-content { padding-top: 1.5rem; }

        /* Tier accent labels */
        .tier-label {
            display: inline-block;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }
        .tier-label-arch { background: rgba(139,92,246,0.15); color: var(--accent-purple); }
        .tier-label-tech { background: rgba(59,130,246,0.15); color: var(--accent-blue-light); }
        .tier-label-walk { background: rgba(16,185,129,0.15); color: var(--accent-green); }

        /* Walkthrough step styling */
        .tier-html .walkthrough-step {
            position: relative;
            padding: 1rem 0 1rem 2.5rem;
            border-left: 2px solid rgba(16,185,129,0.3);
            margin-left: 0.75rem;
        }
        .tier-html .walkthrough-step::before {
            content: attr(data-step);
            position: absolute;
            left: -14px; top: 1rem;
            width: 26px; height: 26px;
            background: var(--accent-green);
            color: var(--bg-base);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 800;
        }

        /* ================================================================
           STATUS BADGES
           ================================================================ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.15rem 0.55rem;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            white-space: nowrap;
        }
        .status-dot { width: 5px; height: 5px; border-radius: 50%; }
        .status-live        { background: rgba(16,185,129,0.12); color: var(--status-live); }
        .status-live .status-dot        { background: var(--status-live); }
        .status-complete    { background: rgba(59,130,246,0.12); color: var(--status-complete); }
        .status-complete .status-dot    { background: var(--status-complete); }
        .status-inprogress  { background: rgba(245,158,11,0.12); color: var(--status-inprogress); }
        .status-inprogress .status-dot  { background: var(--status-inprogress); }
        .status-planned     { background: rgba(100,116,139,0.12); color: var(--status-planned); }
        .status-planned .status-dot     { background: var(--status-planned); }

        /* ================================================================
           STATUS SECTION
           ================================================================ */
        .status-section { padding: 4rem 0; }
        .status-section-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }
        .status-section-header p {
            max-width: 520px;
            margin: 0.5rem auto 0;
            font-size: 0.95rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 0.85rem;
        }
        .status-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem 1.25rem;
            border-left: 3px solid var(--status-planned);
            transition: border-color 0.3s var(--ease);
        }
        .status-card[data-status="Live"]       { border-left-color: var(--status-live); }
        .status-card[data-status="Complete"]   { border-left-color: var(--status-complete); }
        .status-card[data-status="InProgress"] { border-left-color: var(--status-inprogress); }
        .status-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.3rem;
        }
        .status-card-name  { font-weight: 600; font-size: 0.9rem; }
        .status-card-phase { font-size: 0.75rem; color: var(--text-dim); }
        .status-card-notes { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.25rem; }

        /* ================================================================
           FOOTER
           ================================================================ */
        .footer {
            padding: 2rem 0;
            border-top: 1px solid var(--border);
            text-align: center;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        /* ================================================================
           LOADING
           ================================================================ */
        .loading {
            text-align: center;
            padding: 4rem 0;
            color: var(--text-muted);
            grid-column: 1 / -1;
        }
        .spinner {
            width: 28px;
            height: 28px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ================================================================
           SCROLL ANIMATIONS
           ================================================================ */
        .fade-in {
            opacity: 0;
            transform: translateY(16px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* ================================================================
           RESPONSIVE
           ================================================================ */
        @media (max-width: 1100px) {
            .feature-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .feature-grid { grid-template-columns: 1fr; }
            .hero { min-height: 400px; padding: 4rem 1.5rem 3rem; }
            .hero-metrics { gap: 0.75rem; }
            .hero-metric-card { min-width: 140px; padding: 1rem 1.25rem; }
            .hero-metric-value { font-size: 1.5rem; }
            .container, .container-xl { padding: 0 1.25rem; }
            .detail-panel-content { padding: 1.5rem 0; }
            .nav-links { gap: 1rem; }
            .status-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- ============================================================
         STICKY NAV
         ============================================================ -->
    <nav class="nav" id="nav">
        <span class="nav-brand">SmartPiXL</span>
        <div class="nav-links">
            <a href="#capabilities">Capabilities</a>
            <a href="#systemStatus">System Status</a>
        </div>
    </nav>

    <!-- ============================================================
         HERO
         ============================================================ -->
    <header class="hero">
        <div class="hero-glow-1"></div>
        <div class="hero-glow-2"></div>
        <div class="hero-glow-3"></div>
        <div class="hero-grid"></div>
        <div class="hero-content">
            <h1>SmartPiXL</h1>
            <p class="hero-subtitle">
                Cookieless visitor identification powered by 100+ browser signals,
                real-time identity resolution, and enterprise-grade analytics.
            </p>
            <div class="hero-metrics" id="heroMetrics"></div>
        </div>
    </header>

    <!-- ============================================================
         FEATURE GRID
         ============================================================ -->
    <section id="capabilities">
        <div class="section-label">
            <h2>Platform Capabilities</h2>
            <p>Everything that powers cookieless visitor identification, from pixel to person.</p>
        </div>
        <div class="container-xl">
            <div class="feature-grid" id="featureGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading documentation...
                </div>
            </div>
        </div>
    </section>

    <!-- ============================================================
         DETAIL PANEL (hidden until a card is clicked)
         ============================================================ -->
    <section class="detail-panel" id="detailPanel">
        <div class="detail-panel-inner">
            <div class="detail-panel-content">
                <div class="container" id="detailContent"></div>
            </div>
        </div>
    </section>

    <!-- ============================================================
         SYSTEM STATUS
         ============================================================ -->
    <section class="status-section" id="systemStatus" style="display:none">
        <div class="container-xl">
            <div class="status-section-header">
                <h2>System Status</h2>
                <p>Verified against the live codebase. Every status is backed by real, deployed code.</p>
            </div>
            <div class="status-grid" id="statusGrid"></div>
        </div>
    </section>

    <!-- ============================================================
         FOOTER
         ============================================================ -->
    <footer class="footer">
        <div class="container">
            SmartPiXL Atlas &middot; <span id="loadTime"></span>
        </div>
    </footer>

    <!-- ============================================================
         JAVASCRIPT
         ============================================================ -->
    <script>
        // ================================================================
        // CONFIG
        // ================================================================
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                darkMode: true,
                primaryColor: '#3b82f6',
                primaryTextColor: '#edf2f7',
                primaryBorderColor: '#334155',
                lineColor: '#64748b',
                secondaryColor: '#1a2540',
                tertiaryColor: '#111827',
                background: '#080d18',
                mainBkg: '#1a2540',
                nodeBorder: '#334155',
                clusterBkg: '#111827',
                clusterBorder: '#1e293b',
                titleColor: '#edf2f7',
                edgeLabelBackground: '#111827'
            },
            flowchart: { useMaxWidth: true, htmlLabels: true },
            sequence: { useMaxWidth: true },
            gantt: { useMaxWidth: true }
        });

        const ICON_MAP = {
            'globe': 'globe', 'fingerprint': 'fingerprint', 'bolt': 'zap',
            'database': 'database', 'user-check': 'user-check', 'shield': 'shield',
            'map-pin': 'map-pin', 'monitor': 'monitor', 'cpu': 'cpu'
        };

        // ================================================================
        // STATE
        // ================================================================
        let allSections = [];
        let allStatuses = [];
        let allMetrics  = [];
        let selectedSectionId = null;

        // ================================================================
        // UTILITIES
        // ================================================================
        async function fetchJson(url) {
            const r = await fetch(url);
            if (!r.ok) throw new Error(`${url}: ${r.status}`);
            return r.json();
        }

        function statusBadge(status) {
            const cls = (status || 'planned').toLowerCase().replace(/\s+/g, '');
            return `<span class="status-badge status-${cls}"><span class="status-dot"></span>${status}</span>`;
        }

        // ================================================================
        // COUNTER ANIMATION
        // ================================================================
        function animateCounter(el, target) {
            const match = target.match(/^([\d,.]+)(.*)/);
            if (!match) { el.textContent = target; return; }
            const num = parseFloat(match[1].replace(/,/g, ''));
            const suffix = match[2];
            const duration = 1800;
            const start = performance.now();

            function tick(now) {
                const p = Math.min((now - start) / duration, 1);
                const ease = 1 - Math.pow(1 - p, 3);
                el.textContent = Math.round(num * ease).toLocaleString() + suffix;
                if (p < 1) requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        }

        // ================================================================
        // HERO METRICS
        // ================================================================
        function renderHeroMetrics(metrics) {
            const container = document.getElementById('heroMetrics');
            const global = metrics.filter(m => m.sectionId === null);

            container.innerHTML = global.map(m => `
                <div class="hero-metric-card fade-in">
                    <div class="hero-metric-value" data-counter="${m.value}">${m.value}</div>
                    <div class="hero-metric-label">${m.label}</div>
                </div>
            `).join('');

            // Animate counters
            container.querySelectorAll('[data-counter]').forEach(el => {
                animateCounter(el, el.dataset.counter);
            });

            // Stagger fade-in
            requestAnimationFrame(() => {
                container.querySelectorAll('.fade-in').forEach((el, i) => {
                    setTimeout(() => el.classList.add('visible'), i * 120);
                });
            });
        }

        // ================================================================
        // FEATURE GRID
        // ================================================================
        function renderFeatureGrid(sections, metrics, statuses) {
            const grid = document.getElementById('featureGrid');

            // Status map per sectionId
            const statusMap = {};
            statuses.forEach(s => {
                if (s.sectionId) {
                    if (!statusMap[s.sectionId]) statusMap[s.sectionId] = [];
                    statusMap[s.sectionId].push(s);
                }
            });

            // Metric map per sectionId
            const metricMap = {};
            metrics.forEach(m => {
                if (m.sectionId) {
                    if (!metricMap[m.sectionId]) metricMap[m.sectionId] = [];
                    metricMap[m.sectionId].push(m);
                }
            });

            const topLevel = sections.filter(s => !s.parentSectionId);

            grid.innerHTML = topLevel.map((section, idx) => {
                const icon = ICON_MAP[section.iconClass] || 'file-text';
                const sects = statusMap[section.sectionId] || [];
                const liveCount = sects.filter(s => s.status === 'Live').length;
                const primary = liveCount > 0 ? 'Live' : sects.length > 0 ? sects[0].status : null;
                const sMetrics = metricMap[section.sectionId] || [];

                return `
                <div class="feature-card fade-in" data-id="${section.sectionId}"
                     onclick="selectSection(${section.sectionId})"
                     style="transition-delay: ${idx * 60}ms">
                    <div class="card-header">
                        <div class="card-icon"><i data-lucide="${icon}"></i></div>
                        ${primary ? statusBadge(primary) : ''}
                    </div>
                    <h3 class="card-title">${section.title}</h3>
                    <div class="card-pitch">${section.pitchHtml || ''}</div>
                    ${sMetrics.length > 0 ? `
                        <div class="card-metrics">
                            ${sMetrics.map(m => `<span class="card-metric"><strong>${m.value || ''}</strong> ${m.label}</span>`).join('')}
                        </div>
                    ` : ''}
                    <button class="card-explore"
                            onclick="event.stopPropagation(); selectSection(${section.sectionId})">
                        Explore
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                             stroke-width="2.5" stroke-linecap="round">
                            <line x1="5" y1="12" x2="19" y2="12"/>
                            <polyline points="12 5 19 12 12 19"/>
                        </svg>
                    </button>
                </div>`;
            }).join('');

            if (window.lucide) lucide.createIcons();
            observeAnimations();
        }

        // ================================================================
        // SELECT SECTION — open/toggle detail panel
        // ================================================================
        function selectSection(id) {
            const panel = document.getElementById('detailPanel');

            // Same card clicked — close
            if (selectedSectionId === id) {
                closeDetail();
                return;
            }

            selectedSectionId = id;

            // Highlight active card
            document.querySelectorAll('.feature-card').forEach(c => c.classList.remove('active'));
            const card = document.querySelector(`.feature-card[data-id="${id}"]`);
            if (card) card.classList.add('active');

            // Find section data
            const section = allSections.find(s => s.sectionId === id);
            if (!section) return;

            // Build status/metric maps for this section
            const sStatuses = allStatuses.filter(s => s.sectionId === id);
            const liveCount = sStatuses.filter(s => s.status === 'Live').length;
            const primaryStatus = liveCount > 0 ? 'Live' : sStatuses.length > 0 ? sStatuses[0].status : null;
            const sMetrics = allMetrics.filter(m => m.sectionId === id);
            const icon = ICON_MAP[section.iconClass] || 'file-text';

            // ---- Build detail HTML ----
            let html = `
                <div class="detail-header">
                    <div class="detail-title-group">
                        <div class="detail-icon"><i data-lucide="${icon}"></i></div>
                        <div>
                            <div style="display:flex;align-items:center;gap:0.75rem">
                                <span class="detail-title">${section.title}</span>
                                ${primaryStatus ? statusBadge(primaryStatus) : ''}
                            </div>
                        </div>
                    </div>
                    <button class="detail-close" onclick="closeDetail()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>`;

            // Section-specific metrics
            if (sMetrics.length > 0) {
                html += `<div class="detail-section-metrics">${sMetrics.map(m => `
                    <div class="detail-metric">
                        <span class="detail-metric-value">${m.value || 'N/A'}</span>
                        <span class="detail-metric-label">${m.label}</span>
                    </div>`).join('')}</div>`;
            }

            // Primary Mermaid diagram
            if (section.mermaidDiagram) {
                html += `<div class="detail-diagram"><pre class="mermaid">${section.mermaidDiagram}</pre></div>`;
            }

            // Architecture / Management tier
            if (section.managementHtml) {
                html += `
                    <div class="tier-label tier-label-arch">Architecture</div>
                    <div class="tier-html">${section.managementHtml}</div>`;
            }

            // Technical tier expander (contains walkthrough nested inside)
            if (section.technicalHtml) {
                html += `
                    <div class="tier-expander">
                        <button class="tier-toggle" onclick="toggleExpander(this)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                            Technical Details
                        </button>
                        <div class="tier-expand-body">
                            <div class="tier-expand-inner">
                                <div class="tier-expand-content">
                                    <div class="tier-label tier-label-tech">Developer Reference</div>
                                    <div class="tier-html">${section.technicalHtml}</div>
                                    ${section.walkthroughHtml ? buildWalkthroughExpander(section.walkthroughHtml) : ''}
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (section.walkthroughHtml) {
                // No technical tier but has walkthrough
                html += buildWalkthroughExpander(section.walkthroughHtml);
            }

            // Insert content
            const content = document.getElementById('detailContent');
            content.innerHTML = html;

            // Open panel
            panel.classList.add('open');

            // Init icons + Mermaid
            if (window.lucide) lucide.createIcons();
            setTimeout(async () => {
                const diagrams = content.querySelectorAll('.mermaid:not([data-processed])');
                if (diagrams.length > 0) {
                    try { await mermaid.run({ nodes: diagrams }); }
                    catch (e) { console.warn('Mermaid render:', e); }
                }
            }, 150);

            // Smooth scroll to panel
            setTimeout(() => {
                const top = panel.getBoundingClientRect().top + window.scrollY - 70;
                window.scrollTo({ top, behavior: 'smooth' });
            }, 100);
        }

        function buildWalkthroughExpander(walkthroughHtml) {
            return `
                <div class="tier-expander">
                    <button class="tier-toggle" onclick="toggleExpander(this)">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <polyline points="6 9 12 15 18 9"/>
                        </svg>
                        Full Walkthrough
                    </button>
                    <div class="tier-expand-body">
                        <div class="tier-expand-inner">
                            <div class="tier-expand-content">
                                <div class="tier-label tier-label-walk">Step-by-Step Narrative</div>
                                <div class="tier-html">${walkthroughHtml}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function closeDetail() {
            selectedSectionId = null;
            document.getElementById('detailPanel').classList.remove('open');
            document.querySelectorAll('.feature-card').forEach(c => c.classList.remove('active'));
        }

        // ================================================================
        // TIER EXPANDER
        // ================================================================
        function toggleExpander(btn) {
            const body = btn.nextElementSibling;
            const isOpen = body.classList.contains('open');

            if (isOpen) {
                body.classList.remove('open');
                btn.classList.remove('expanded');
            } else {
                body.classList.add('open');
                btn.classList.add('expanded');

                // Render Mermaid diagrams that just became visible
                setTimeout(async () => {
                    const diagrams = body.querySelectorAll('.mermaid:not([data-processed])');
                    if (diagrams.length > 0) {
                        try { await mermaid.run({ nodes: diagrams }); }
                        catch (e) { console.warn('Mermaid render:', e); }
                    }
                }, 150);
            }
        }

        // ================================================================
        // STATUS GRID
        // ================================================================
        function renderStatusGrid(statuses) {
            if (!statuses.length) return;

            document.getElementById('systemStatus').style.display = '';
            const grid = document.getElementById('statusGrid');

            // Sort: Live → Complete → InProgress → Planned
            const order = { 'Live': 0, 'Complete': 1, 'InProgress': 2, 'Planned': 3 };
            statuses.sort((a, b) => (order[a.status] ?? 9) - (order[b.status] ?? 9));

            grid.innerHTML = statuses.map(s => `
                <div class="status-card fade-in" data-status="${s.status}">
                    <div class="status-card-header">
                        <span class="status-card-name">${s.systemName}</span>
                        ${statusBadge(s.status)}
                    </div>
                    <div class="status-card-phase">${s.phase || ''}</div>
                    ${s.notes ? `<div class="status-card-notes">${s.notes}</div>` : ''}
                </div>
            `).join('');

            observeAnimations();
        }

        // ================================================================
        // SCROLL OBSERVER FOR ANIMATIONS
        // ================================================================
        function observeAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.08 });

            document.querySelectorAll('.fade-in:not(.visible)').forEach(el => observer.observe(el));
        }

        // ================================================================
        // NAV SCROLL BEHAVIOR
        // ================================================================
        window.addEventListener('scroll', () => {
            document.getElementById('nav').classList.toggle('visible', window.scrollY > 300);
        }, { passive: true });

        // ================================================================
        // KEYBOARD SHORTCUTS
        // ================================================================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && selectedSectionId !== null) closeDetail();
        });

        // ================================================================
        // INIT
        // ================================================================
        async function init() {
            document.getElementById('loadTime').textContent = new Date().toLocaleString();

            try {
                const [sections, statuses, metrics] = await Promise.all([
                    fetchJson('/api/atlas/sections'),
                    fetchJson('/api/atlas/status'),
                    fetchJson('/api/atlas/metrics')
                ]);

                allSections = sections;
                allStatuses = statuses;
                allMetrics  = metrics;

                renderHeroMetrics(metrics);
                renderFeatureGrid(sections, metrics, statuses);
                renderStatusGrid(statuses);

            } catch (err) {
                console.error('Atlas init error:', err);
                document.getElementById('featureGrid').innerHTML = `
                    <div class="loading" style="color:var(--accent-red)">
                        Failed to load documentation.<br>
                        <small>${err.message}</small>
                    </div>`;
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
