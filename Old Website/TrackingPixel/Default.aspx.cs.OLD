using System;
using System.Collections.Generic;
using System.IO;
using System.Web.UI;
using M1_Data;
using System.Net;
using Newtonsoft.Json;

public partial class _Default : Page
{
    public class IpLocation
    {
        public string IP { get; set; }
        public string Country { get; set; }
        public string CountryCode { get; set; }
        public string Region { get; set; }
        public string RegionName { get; set; }
        public string City { get; set; }
        public string Zip { get; set; }
        public string Lat { get; set; }
        public string Lon { get; set; }
        public string Timezone { get; set; }
        public string ISP { get; set; }
        public string Org { get; set; }
        public string As { get; set; }
        public string Reverse { get; set; }
        public string Mobile { get; set; }
        public string Proxy { get; set; }
        public Nullable<System.DateTime> LastUpdated { get; set; }
        public string Status { get; set; }
        public string Message { get; set; }

        public override string ToString()
        {
            return Country + ',' + CountryCode + ',' + Region + ',' + RegionName + ',' + City + ',' + Zip + ',' + Lat + ',' + Lon + ',' + Timezone + ',' + ISP + ',' + Org + ',' + As + ',' + Reverse + ',' + Mobile + ',' + Proxy + ',' + Status + ',' + Message;
        }
    }

	static private M1_SQL M1SQL = new M1_SQL("PiXL", "9f2A$_!", "127.0.0.1", "PiXL");
	
    protected void Page_Load(object sender, EventArgs e)
    {
		try
		{
			string FilePath = @"C:\inetpub\TrackingPixel\loggerCSV.csv";

			Dictionary<string, string> ServerVariables = new Dictionary<string, string>();
			string SQL = string.Empty;
			string SQL2 = string.Empty;
			string ColumnNames = string.Empty;
			string line = string.Empty;
			int index = 0;
			string Referer = string.Empty;
            string RefererQuery = string.Empty;

			SQL = "Insert Into ASP_PiXL_New ( ";

            foreach (string var in Request.ServerVariables)
            {
                if (var.ToUpper().Equals("REMOTE_ADDR"))
                    line += '"' + Request[var] + "\",";
                if ("REMOTE_ADDR,HTTP_REFERER,HTTP_USER_AGENT,REQUEST_URI".ToUpper().Contains(var.ToUpper()))
                    line += '"' + var + "\",";
                if ("HTTP_X_ORIGINAL_URL, HTTP_ACCEPT_LANGUAGE, HTTP_COOKIE, HTTP_USER_AGENT, REMOTE_ADDR, REQUEST_METHOD, HTTP_ALEXATOOLBAR_ALX_NS_PH, HTTP_CACHE_CONTROL, HTTP_CLIENT_IP, HTTP_CUDA_CLIIP, HTTP_DNT, HTTP_FORWARDED, HTTP_FROM, HTTP_PROXY_CONNECTION, HTTP_RVBD_CSH, HTTP_RVBD_SSH, HTTP_TRANSACTION_ID, HTTP_USER_FULLNAME, HTTP_VIA, HTTP_X_AUTHENTICATED_USER, HTTP_X_DEVTOOLS_EMULATE_NETWORK_CONDITIONS_CLIENT_ID, HTTP_X_DEVTOOLS_REQUEST_ID, HTTP_X_GETZIP, HTTP_X_MATRIX_PROXY, HTTP_X_MCPROXYFILTER, HTTP_X_NEWRELIC_ID, HTTP_X_OPERAMINI_PHONE_UA, HTTP_X_OPWVFORWARDED_FOR, HTTP_X_RBT_OPTIMIZED_BY, HTTP_X_RBT_SCAR, HTTP_X_SHAREPATH_RUM_ENABLED, HTTP_X_TARGET_PROXY".ToUpper().Contains(var.ToUpper()))
                    ServerVariables.Add(var, Request[var]);
            }
            Referer = Request["HTTP_REFERER"];

            if (Referer != null)
            {
                Referer = Referer.Replace("%26amp", string.Empty);
                Referer = Referer.Replace("%3Bamp", string.Empty);
                Referer = Referer.Replace("%23x3b", string.Empty);
                Referer = Referer.Replace("%3Bx3b", string.Empty);
                Referer = Referer.Replace("%23x23", string.Empty);
                Referer = Referer.Replace("%3Bx23", string.Empty);
                Referer = Referer.Replace("%3Bx2f", string.Empty);
                Referer = Referer.Replace("%3Bx3a", string.Empty);
                Referer = Referer.Replace("%26", string.Empty);
                Referer = Referer.Replace("%3B", string.Empty);

				if(Referer.Contains("?"))
				{
					ServerVariables.Add("HTTP_REFERER_ROOT", Referer.Split('?')[0]);
					ServerVariables.Add("HTTP_REFERER_QUERY", Referer.Split('?')[1]);
				}
				else
					ServerVariables.Add("HTTP_REFERER_ROOT", Referer);
            }
			
			ServerVariables.Add("HTTP_REFERER", Referer);
			

            if(Request.Headers != null)
            foreach (var key in Request.Headers.AllKeys)
                if ("REQUEST_Headers_Accept_Language, REQUEST_Headers_Cookie, REQUEST_Headers_Forwarded_For, REQUEST_Headers_x_att_deviceid, REQUEST_Headers_X_BlueCoat_Via, REQUEST_Headers_X_IWS_Via, REQUEST_Headers_X_MWG_Via, REQUEST_Headers_X_P2P_PeerDist, REQUEST_Headers_X_Proxy_ID, REQUEST_Headers_X_Requested_With, REQUEST_Headers_x_wap_profile, REQUEST_Headers_Z_Forwarded_For".ToUpper().Contains(("REQUEST_Headers_" + key.Replace('-', '_')).ToUpper()))
                    ServerVariables.Add("REQUEST_Headers_" + key.Replace('-', '_'), Request.Headers[key].ToString());

            if (Request.Params != null)
                foreach (var key in Request.Params.AllKeys)
                if ("REQUEST_Params_REMOTE_PORT".ToUpper().Contains(("REQUEST_Params_" + key).ToUpper()))
                    ServerVariables.Add("REQUEST_Params_" + key, Request.Params[key].ToString());

            if (Request.Browser != null)
            {
                ServerVariables.Add("BROWSER_BackgroundSounds", Request.Browser.BackgroundSounds.ToString());
                ServerVariables.Add("BROWSER_Browser", Request.Browser.Browser);

                index = 1;
                foreach (var key in Request.Browser.Browsers.ToArray())
                    if (index <= 6)
                        ServerVariables.Add("BROWSER_Browsers_" + index++.ToString(), key.ToString());

				if(Request.Browser.CanInitiateVoiceCall != null)
					ServerVariables.Add("BROWSER_CanInitiateVoiceCall", Request.Browser.CanInitiateVoiceCall.ToString());

				if(Request.Browser.Capabilities != null)
                foreach (var key in Request.Browser.Capabilities.Keys)
                    if ("BROWSER_Capabilities_inputType, BROWSER_Capabilities_layoutEngineVersion".ToUpper().Contains(("BROWSER_Capabilities_" + key).ToUpper()))
                        ServerVariables.Add("BROWSER_Capabilities_" + key, Request.Browser.Capabilities[key].ToString());


                ServerVariables.Add("BROWSER_Crawler", Request.Browser.Crawler.ToString());
                ServerVariables.Add("BROWSER_Frames", Request.Browser.Frames.ToString());

                index = 1;
                foreach (var key in Request.Browser.GetClrVersions())
                    if (index <= 1)
                        ServerVariables.Add("BROWSER_GetClrVersions_" + index++.ToString(), key.ToString());

                ServerVariables.Add("BROWSER_GetHashCode", Request.Browser.GetHashCode().ToString());
                ServerVariables.Add("BROWSER_Id", Request.Browser.Id);
                ServerVariables.Add("BROWSER_IsColor", Request.Browser.IsColor.ToString());
                ServerVariables.Add("BROWSER_IsMobileDevice", Request.Browser.IsMobileDevice.ToString());
                ServerVariables.Add("BROWSER_JavaApplets", Request.Browser.JavaApplets.ToString());
                ServerVariables.Add("BROWSER_JScriptVersion", Request.Browser.JScriptVersion != null ? Request.Browser.JScriptVersion.ToString() : string.Empty);
                ServerVariables.Add("BROWSER_MaximumRenderedPageSize", Request.Browser.MaximumRenderedPageSize.ToString());
                ServerVariables.Add("BROWSER_MobileDeviceModel", Request.Browser.MobileDeviceModel);
                ServerVariables.Add("BROWSER_Platform", Request.Browser.Platform);
                ServerVariables.Add("BROWSER_SupportsAccesskeyAttribute", Request.Browser.SupportsAccesskeyAttribute.ToString());
                ServerVariables.Add("BROWSER_SupportsDivNoWrap", Request.Browser.SupportsDivNoWrap.ToString());
                ServerVariables.Add("BROWSER_Version", Request.Browser.Version);
                ServerVariables.Add("BROWSER_Win32", Request.Browser.Win32.ToString());
            }

            ServerVariables.Add("REQUEST_GetHashCode", Request.GetHashCode().ToString());

            if (Request.Unvalidated != null && Request.Unvalidated.Headers != null)
                foreach (var key in Request.Unvalidated.Headers.AllKeys)
                if ("UNVALIDATED_Headers_X_IMForwards".ToUpper().Contains(("UNVALIDATED_Headers_" + key.Replace('-', '_')).ToUpper()))
                    ServerVariables.Add("UNVALIDATED_Headers_" + key.Replace('-', '_'), Request.Unvalidated.Headers[key].ToString());

            if (Request.Url != null)
                ServerVariables.Add("REQUEST_URL_OriginalString", Request.Url.OriginalString);

            if (Request.UrlReferrer != null)
            {
                ServerVariables.Add("REQUEST_UrlReferrer_HostNameType", Request.UrlReferrer.HostNameType.ToString());
                ServerVariables.Add("REQUEST_UrlReferrer_Port", Request.UrlReferrer.Port.ToString());
            }

			foreach (var item in ServerVariables)
			{
				ColumnNames += item.Key + ';';
				SQL += "[" + item.Key + "], ";
				SQL2 += "'" + item.Value + "', ";
			}

			line = '"' + DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss") + "\",";
			line += '"' + Request["REMOTE_ADDR"] + "\",";
			line += '"' + Request["HTTP_REFERER"] + "\",";
			line += '"' + Request["HTTP_USER_AGENT"] + "\",";
			line += '"' + Request["REQUEST_URI"] + "\"";

			//ColumnNames = ColumnNames.Substring(0, ColumnNames.Length - 1);
			//M1SQL.SQLExecuteStoredProcedure("SP_ADD_ASP_PiXL", new List<M1_SQL.SQLParameterMap>() { new M1_SQL.SQLParameterMap("@ColumnNames", ColumnNames) });
			SQL = SQL.Substring(0, SQL.Length - 2) + ") VALUES ( " + SQL2.Substring(0, SQL2.Length - 2) + ")";

			//new M1_Result(false, SQL);

			M1SQL.SQLRunQuery(SQL);

			//Insert Ip_Location table Details
			string strRemoteAddress = Request.ServerVariables["REMOTE_ADDR"];
			string ipaddress;
			ipaddress = Request.ServerVariables["HTTP_X_FORWARDED_FOR"];
			if (ipaddress == "" || ipaddress == null)
				ipaddress = Request.ServerVariables["REMOTE_ADDR"];

			try
			{
				bool isInserted = InsertIPDetails(ipaddress);

				/*
				if (isInserted == true)
				{
					Response.Write("Insert IP Details Successfully........ ");
				}
				else
				{
					Response.Write(" Invalid Id address...... ");
				}*/
			}
			catch (Exception)
			{
				throw;
			}
		}
		catch (Exception exc)
		{
			new M1_Result(false, exc.ToString());
		}
    }
    private bool InsertIPDetails(string remoteAddress)
    {
        bool value = true;

        try
        {
            if (remoteAddress.Contains("."))
            {
                dynamic client = new WebClient();
                client.Headers.Add("Content-Type:application/json"); //Content-Type  
                client.Headers.Add("Accept:application/json");
                dynamic result = client.DownloadString("https://pro.ip-api.com/json/" + remoteAddress + "?key=oJC4NplwJaCnbWw"); //URI  
                dynamic val = result;
                IpLocation objIp_location = JsonConvert.DeserializeObject<IpLocation>(result);
                //WriteIPDetails(remoteAddress, objIp_location);

                M1SQL.SQLExecuteStoredProcedure("SP_ADD_IP_Location", new List<M1_SQL.SQLParameterMap>()
                {
                    new M1_SQL.SQLParameterMap ("@IP", remoteAddress),
                    new M1_SQL.SQLParameterMap ("@Country", objIp_location.Country),
                    new M1_SQL.SQLParameterMap ("@CountryCode", objIp_location.CountryCode),
                    new M1_SQL.SQLParameterMap ("@Region", objIp_location.Region),
                    new M1_SQL.SQLParameterMap ("@RegionName", objIp_location.RegionName),
                    new M1_SQL.SQLParameterMap ("@City", objIp_location.City),
                    new M1_SQL.SQLParameterMap ("@Zip", objIp_location.Zip),
                    new M1_SQL.SQLParameterMap ("@Lat ", objIp_location.Lat),
                    new M1_SQL.SQLParameterMap ("@Lon", objIp_location.Lon),
                    new M1_SQL.SQLParameterMap ("@Timezone", objIp_location.Timezone),
                    new M1_SQL.SQLParameterMap ("@isp", objIp_location.ISP),
                    new M1_SQL.SQLParameterMap ("@Org", objIp_location.Org),
                    new M1_SQL.SQLParameterMap ("@As", objIp_location.As),
                    new M1_SQL.SQLParameterMap ("@Reverse", objIp_location.Reverse),
                    new M1_SQL.SQLParameterMap ("@Mobile", objIp_location.Mobile),
                    new M1_SQL.SQLParameterMap ("@Proxy", objIp_location.Proxy),
                    // new M1_SQL.SQLParameterMap ("@LastUpdated", apilocation.LastUpdated),
                    new M1_SQL.SQLParameterMap ("@Status", objIp_location.Status),
                    new M1_SQL.SQLParameterMap ("@Message", objIp_location.Message)
                });
            }
            else
            {
                value = false;
            }
        }
        catch (Exception ex)
        {
            throw;
        }

        return value;
    }

    private void WriteIPDetails(string IP, IpLocation Location)
    {
        string outFile = @"C:\inetpub\TrackingPixel\IP_Location.csv";

        using (StreamWriter SW = new StreamWriter(outFile, true))
        {
            SW.WriteLine(IP + ',' + Location.ToString());
        }
    }
}