<%
dim reresponse, SecretKey, VarString, url
reresponse= Request.form("g-recaptcha-response")
SecretKey = "6LdZd0kfAAAAAF1QfNdxvJXG8KJHW5LfQlR9KWH4"

VarString = "?secret=" & SecretKey & _
          "&response=" & reresponse
url="https://www.google.com/recaptcha/api/siteverify" & VarString

Dim objXmlHttp
Set objXmlHttp = Server.CreateObject("MSXML2.XMLHTTP.6.0")
objXmlHttp.open "POST", url, False
objXmlHttp.setRequestHeader "Content-Type", "application/x-www-form-urlencoded"
objXmlHttp.send

Dim ResponseString
ResponseString = objXmlHttp.responseText
'Response.Write(ResponseString)
Set objXmlHttp = Nothing

dim firstname, lastname, address1, address2, city, state, zip, email, phone, ipaddress, requesttype, source
If instr(ResponseString, "success" & chr(34) &": true")>0  then

  firstname = request.form("FName")
  firstname = replace(firstname,"'","")

  lastname = request.form("LName")
  lastname = replace(lastname,"'","")

  address1 = request.form("Address")
  address1 = replace(address1,"'","")

  address2 = request.form("Apartment")
  address2 = replace(address2,"'","")

  city = request.form("City")
  city = replace(city,"'","")

  state = request.form("State")
  state = replace(state,"'","")

  zip = request.form("Zip")
  zip = replace(zip,"'","")

  email = request.form("EmailId")
  email = replace(email,"'","")

  phone = request.form("Phone")
  phone = replace(phone,"'","")

  requesttype = request.form("RequestType")
  ipaddress = request.form("RemoteAddress")
  
  source = "m1-data.com"

  set oConn = Server.CreateObject("ADODB.connection")
  connStr = "Driver={ODBC Driver 13 for SQL Server};" & _
             "Server=127.0.0.1;" & _
             "Database=SmartPiXL;" & _
             "Uid=PiXL;" & _
             "Pwd=9f2A$_!;"
  oConn.Open connStr

  UserAgent = request.servervariables("HTTP_USER_AGENT")
  'ipaddress = request.servervariables("HTTP_X_FORWARDED_FOR")
  ipaddress = request.servervariables("remote_addr")

  SQL = "exec SP_PiXL_Unsub '" + firstname + "', '" + lastname + "', '" + address1 + "', '" + address2 + "', '" + city + "', '" + state + "', '" + zip + "', '" + email + "', '" + phone + "', '" + requesttype + "', '" + ipaddress + "', '" + source + "', '" + UserAgent + "'"

  oConn.execute(SQL)
  
  'response.write(SQL)

  response.write("Thank you for your request.  We will unsubscribe you from our mailing lists.")

else
  response.write("Robot verification failed. Please try again.")
end if


%>